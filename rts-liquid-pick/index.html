<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTS | Liquidation</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.16.0/pdf-lib.min.js"></script> <!-- Xu·∫•t PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <link rel="stylesheet" href="styles.css">
</head>
<body>

    
    <header>
        <img id="logo" src="shopee_logo_white_en.png">
        <h1>RTS / Liquidation</h1>
    </header>
    
    <button style="margin-left: 50px; cursor: pointer;" class="group-btn" onclick="downloadAll()">
        Create Label & Download <i class="fa-solid fa-download"></i> 
    </button>    

    <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 25px;">
        <div class="filter-container">
            <div class="filter-group">
                <label for="filterClearance">Clearance Action:</label>
                <select id="filterClearance" onchange="filterTable()">
                    <option value="All">All</option>
                </select>
        
                <label for="filterGroup">Nh√≥m SKUs:</label>
                <select id="filterGroup" onchange="filterTable()">
                    <option value="All">All</option>
                </select>
        
                <label for="filterLocation">Zone:</label>
                <select style="width: 100px;" id="filterLocation" onchange="filterTable()">
                    <option value="All">All</option>
                </select>
        
                <label for="filterPickup">Pickup Type:</label>
                <select id="filterPickup" onchange="filterTable()">
                    <option value="All">All</option>
                </select>

                
            </div>
        </div>

        <p id="resultCount" style="margin-left: 20px; font-weight: bold; font-size: 20px;"></p>
    </div>
    
    <table id="skuTable">
        <thead>
            <tr>
                <th>MT SKU ID</th>
                <th>Clearance action</th>
                <th>NhoÃÅm SKUs</th>
                <th>Target qty</th>
                <th>SKU Name</th>
                <th>Available Qty</th>
                <th>Location</th>
                <th>Pickup Type</th>
            </tr>
        </thead>
        <tbody>
            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
        </tbody>
    </table>

    <!-- Modal ch·ªçn Warehouse -->
    <div id="warehouseModal" class="modal_wh" style="display: block;">
        <div class="modal-content_wh">
            <h2>Ch·ªçn Warehouse</h2>
            <select id="warehouseSelect" style="padding: 10px; width: 60%; font-size: 16px;">
                <option value="VNSC">VNSC</option>
                <option value="VNNC">VNNC</option>
                <option value="VNW">VNW</option>
                <option value="VNC">VNC</option>
            </select>
            <br><br>
            <input type="file" id="excelInput" accept=".xlsx, .xls" style="display: none;" onchange="handleFileUpload(event)">
            <button onclick="document.getElementById('excelInput').click()" style="padding: 10px 15px; background-color: darkgreen; color: white; border: none; cursor: pointer; border-radius: 4px; width: 65%;">
                Upload Available Inventory <i class="fa-solid fa-upload"></i>
            </button>

            <br><br>
            <button onclick="confirmWarehouse()" style="padding: 10px 15px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px;">
                X√°c nh·∫≠n <i class="fa-solid fa-check-circle"></i>
            </button>
        </div>
    </div>

    <!-- Hi·ªÉn th·ªã khi ƒëang t·∫£i d·ªØ li·ªáu -->
    <div id="loading" style="display: none; text-align: center; margin-top: 20px;">
        <div class="spinner"></div>
        <p>ƒêang t·∫£i d·ªØ li·ªáu, vui l√≤ng ch·ªù...</p>
    </div>

    <!-- Modal Progress Xu·∫•t PDF -->
    <div id="progressModal" class="modal_wh" style="display: none;">
        <div class="modal-content_wh">
            <h2>ƒêang t·∫°o Picklist...</h2>
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <p style="font-size: 24px; font-weight: bold;" id="progressText">0%</p>
        </div>
    </div>

    <footer>
        &copy; 2025 RTS/Liquidation Picking. Version 2.21.1157 tool ƒë∆∞·ª£c build b·ªüi hau.giang@shopee.com.
    </footer>

    <script>
        window.addEventListener("scroll", function () {
            let header = document.querySelector("header");

            if (window.scrollY > 50) {
                header.classList.add("header-small"); // Th√™m hi·ªáu ·ª©ng khi cu·ªôn xu·ªëng
            } else {
                header.classList.remove("header-small"); // Quay l·∫°i tr·∫°ng th√°i ban ƒë·∫ßu khi cu·ªôn l√™n
            }
        });



        // Hi·ªÉn th·ªã modal khi v√†o trang web
        window.onload = function () {
            document.getElementById("warehouseModal").style.display = "block";
        };
        
        let selectedWarehouse = ""; // Bi·∫øn l∆∞u gi√° tr·ªã warehouse ƒë√£ ch·ªçn
        let excelData = [];  // L∆∞u d·ªØ li·ªáu t·ª´ file Excel


        // Khi x√°c nh·∫≠n warehouse
        function confirmWarehouse() {
            selectedWarehouse = document.getElementById("warehouseSelect").value;
            document.getElementById("warehouseModal").style.display = "none"; // ·∫®n modal

            if (excelData.length === 0) {
                alert("Vui l√≤ng upload file tr∆∞·ªõc khi x√°c nh·∫≠n!");
                document.getElementById("warehouseModal").style.display = "block"; // Hi·ªÉn th·ªã l·∫°i modal
                return;
            }

            load_data(); // T·∫£i d·ªØ li·ªáu t·ª´ API
        }


        function filterTable() {
            // let input = document.getElementById("searchInput").value.toLowerCase();
            let filterClearance = document.getElementById("filterClearance").value;
            let filterGroup = document.getElementById("filterGroup").value;
            let filterLocation = document.getElementById("filterLocation").value;
            let filterPickup = document.getElementById("filterPickup").value;

            let table = document.getElementById("skuTable");
            let rows = table.getElementsByTagName("tr");
            let visibleRowCount = 0; // Bi·∫øn ƒë·∫øm s·ªë d√≤ng hi·ªÉn th·ªã

            for (let i = 1; i < rows.length; i++) { // B·ªè qua h√†ng ti√™u ƒë·ªÅ (index 0)
                let cells = rows[i].getElementsByTagName("td");
                let rowText = "";
                for (let j = 0; j < cells.length; j++) {
                    rowText += cells[j].textContent.toLowerCase() + " ";
                }

                // let matchSearch = rowText.includes(input);
                let matchClearance = filterClearance === "All" || cells[1].textContent === filterClearance;
                let matchGroup = filterGroup === "All" || cells[2].textContent === filterGroup;
                
                // üî• Gi·ªØ nguy√™n gi√° tr·ªã `Location`, nh∆∞ng l·ªçc theo ph·∫ßn t·ª≠ th·ª© 2
                let fullLocation = cells[6].textContent;
                let splitLocation = fullLocation.includes("-") ? fullLocation.split("-")[1] : fullLocation;

                let matchLocation = filterLocation === "All" || splitLocation.includes(filterLocation);

                let matchPickup = filterPickup === "All" || cells[7].textContent === filterPickup;

                if (matchClearance && matchGroup && matchLocation && matchPickup) {
                    rows[i].style.display = "";
                    visibleRowCount++;
                } else {
                    rows[i].style.display = "none";
                }
            }

            // C·∫≠p nh·∫≠t s·ªë d√≤ng hi·ªÉn th·ªã tr√™n giao di·ªán
            document.getElementById("resultCount").textContent = `${visibleRowCount} k·∫øt qu·∫£`;
        }

        function loadTableData(data) {
            const tableBody = document.querySelector("#skuTable tbody");
            tableBody.innerHTML = ""; // X√≥a d·ªØ li·ªáu c≈©

            let clearanceActions = new Set();
            let groups = new Set();
            let locations = new Set();
            let pickupTypes = new Set();

            data.forEach((row, index) => {
                let tr = document.createElement("tr");

                row.forEach((cell, cellIndex) => {
                    let td = document.createElement("td");

                    // N·∫øu l√† c·ªôt "Location" (c·ªôt index 6), gi·ªØ nguy√™n gi√° tr·ªã nh∆∞ng l∆∞u gi√° tr·ªã th·ª© 2 v√†o danh s√°ch filter
                    if (cellIndex === 6) {
                        let splitLocation = cell.includes("-") ? cell.split("-")[1] : cell; // L·∫•y ph·∫ßn t·ª≠ th·ª© 2
                        locations.add(splitLocation); // L∆∞u gi√° tr·ªã l·ªçc nh∆∞ng KH√îNG thay ƒë·ªïi b·∫£ng
                        td.textContent = cell; // Gi·ªØ nguy√™n gi√° tr·ªã g·ªëc tr√™n b·∫£ng
                    } else {
                        td.textContent = cell;
                    }

                    tr.appendChild(td);
                });

                // L∆∞u c√°c gi√° tr·ªã duy nh·∫•t cho dropdown
                clearanceActions.add(row[1]); // C·ªôt 2
                groups.add(row[2]); // C·ªôt 3
                pickupTypes.add(row[7]); // C·ªôt 8

                tableBody.appendChild(tr);
            });

            // C·∫≠p nh·∫≠t dropdown filter (Location ch·ªâ l·∫•y gi√° tr·ªã th·ª© 2)
            updateDropdown("filterClearance", clearanceActions);
            updateDropdown("filterGroup", groups);
            updateDropdown("filterLocation", locations);
            updateDropdown("filterPickup", pickupTypes);
        }

        // H√†m c·∫≠p nh·∫≠t dropdown v·ªõi gi√° tr·ªã duy nh·∫•t
        function updateDropdown(dropdownId, values, isLocation = false) {
            let dropdown = document.getElementById(dropdownId);
            dropdown.innerHTML = '<option value="All">All</option>'; // Reset dropdown

            let uniqueValues = new Set();
            
            values.forEach(value => {
                if (value !== "") {
                    let displayValue = isLocation ? (value.includes("-") ? value.split("-")[1] : value) : value;
                    uniqueValues.add(displayValue);
                }
            });

            uniqueValues.forEach(value => {
                let option = document.createElement("option");
                option.value = value;
                option.textContent = value;
                dropdown.appendChild(option);
            });
        }


    // üåü S·∫Øp x·∫øp location theo c·∫•p ƒë·ªô trong Location
    // üåü H√†m s·∫Øp x·∫øp `finalSelection` theo c·∫•p ƒë·ªô trong `Location`
    function sortFinalSelectionByLocation(data) {
        data.sort((a, b) => {
            let splitA = a.location.split("-").map((val, index) => (index >= 2 ? parseInt(val, 10) || 0 : val));
            let splitB = b.location.split("-").map((val, index) => (index >= 2 ? parseInt(val, 10) || 0 : val));

            for (let i = 0; i < splitA.length; i++) {
                if (splitA[i] < splitB[i]) return -1;
                if (splitA[i] > splitB[i]) return 1;
            }
            return 0;
        });
    }

    async function downloadAll() {
        let displayedRows = getDisplayedRows();
        if (displayedRows.length === 0) {
            alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i.");
            return;
        }

        let groupedData = {};  // L∆∞u tr·ªØ SKU theo nh√≥m ƒë·ªÉ x·ª≠ l√Ω target qty

        // Nh√≥m SKU theo ID
        displayedRows.forEach(row => {
            let sku = row[0]; // SKU ID
            let sku_name = row[4]; // SKU Name
            let group = row[2]; // Nh√≥m SKU
            let targetQty = parseInt(row[3]); // Target Qty
            let location = row[6]; // Location
            let availableQty = parseInt(row[5]); // Available Qty
            let type = row[1]; // Type

            if (!groupedData[sku]) {
                groupedData[sku] = {
                    sku_name: sku_name,  // üÜï L∆∞u l·∫°i SKU Name
                    type: type, // üÜï L∆∞u lo·∫°i Clearance
                    group: group,
                    targetQty: targetQty,
                    totalAvailableQty: 0,
                    locations: [],
                };
            }

            groupedData[sku].totalAvailableQty += availableQty;
            groupedData[sku].locations.push({ location, availableQty });
        });

        console.log("üî• D·ªØ li·ªáu nh√≥m:", groupedData);
        let finalSelection = [];

        // X·ª≠ l√Ω d·ªØ li·ªáu theo nh√≥m
        Object.keys(groupedData).forEach(sku => {
            let { sku_name, type, group, targetQty, totalAvailableQty, locations } = groupedData[sku];

            if (group === "1. Clear h√™ÃÅt stock v√™ÃÄ 0") {
                // üåü Pick theo th·ª© t·ª± Location ∆∞u ti√™n
                locations.forEach(loc => {
                    finalSelection.push({
                        sku,
                        sku_name,
                        type,
                        targetQty,
                        totalAvailableQty,
                        location: loc.location,
                        qty: loc.availableQty,
                        des_loc: lq_loc
                    });
                });
            } 
            else if (group === "2. Clear stock t√¥ÃÅi ƒëa bƒÉÃÄng m∆∞ÃÅc target") {
                // ‚ùå N·∫øu t·ªïng Available Qty < Target ‚Üí B·ªè qua SKU n√†y
                if (totalAvailableQty < targetQty) {
                    console.log(`‚ùå SKU ${sku} b·ªã b·ªè qua v√¨ totalAvailableQty (${totalAvailableQty}) < targetQty (${targetQty})`);
                    return;
                }

                // ‚úÖ X√°c ƒë·ªãnh s·ªë l∆∞·ª£ng c·∫ßn PICK: Available - Target
                let qtyToPick = totalAvailableQty - targetQty;

                let remainingToPick = qtyToPick;
                for (let loc of locations) {
                    if (remainingToPick <= 0) break;
                    let pickQty = Math.min(loc.availableQty, remainingToPick);

                    finalSelection.push({
                        sku,
                        sku_name,
                        type,
                        targetQty,
                        totalAvailableQty,
                        location: loc.location,
                        qty: pickQty,
                        des_loc: lq_loc
                    });

                    remainingToPick -= pickQty;
                }
            }
        });

        // üõë **B·ªè qua n·∫øu kh√¥ng c√≥ SKU h·ª£p l·ªá**
        if (finalSelection.length === 0) {
            alert("Kh√¥ng c√≥ SKU n√†o h·ª£p l·ªá ƒë·ªÉ in.");
            return;
        }

        // üåü **Sort to√†n b·ªô danh s√°ch `finalSelection` theo Location**
        sortFinalSelectionByLocation(finalSelection);

        console.log("üî• FinalSelection sau khi s·∫Øp x·∫øp:", finalSelection);

        let pdfDoc = await PDFLib.PDFDocument.create();
        let pdfWidth = 288;
        let pdfHeight = 144;
        let canvas = document.createElement("canvas");
        canvas.width = 800;
        canvas.height = 400;
        let counter = 1; // B·∫Øt ƒë·∫ßu t·ª´ 1

        // Hi·ªÉn th·ªã modal progress
        document.getElementById("progressModal").style.display = "block";
        let progressBar = document.getElementById("progressBar");
        let progressText = document.getElementById("progressText");

        for (let i = 0; i < finalSelection.length; i++) {
            let row = finalSelection[i];
            let sku = row.sku;          // SKU ID
            let sku_name = row.sku_name || "N/A"; // T√™n s·∫£n ph·∫©m (fallback n·∫øu undefined)
            let location = row.location; // V·ªã tr√≠ trong kho
            let des_loc = row.des_loc;   // M√£ kho ƒë√≠ch
            let qty = row.qty;           // S·ªë l∆∞·ª£ng c·∫ßn l·∫•y
            let type = row.type || "N/A"; // Lo·∫°i clearance (fallback n·∫øu undefined)
            let targetQty = row.targetQty; // S·ªë l∆∞·ª£ng m·ª•c ti√™u
            let totalAvailableQty = row.totalAvailableQty; // T·ªïng t·ªìn kho

            // üõë **B·ªè qua SKU n·∫øu t·ªïng Available < Target**
            if (totalAvailableQty < targetQty) {
                console.log(`‚ùå B·ªè qua SKU: ${sku}, Total Available (${totalAvailableQty}) < Target (${targetQty})`);
                continue;
            }

            // üî¢ **C·∫≠p nh·∫≠t ti·∫øn tr√¨nh**
            let progressPercent = Math.round(((i + 1) / finalSelection.length) * 100);
            progressBar.style.width = progressPercent + "%";
            progressText.textContent = progressPercent + "%";

            // üñ®Ô∏è **T·∫°o barcode cho Location**
            let barcodeImage = await generateBarcode(des_loc);

            // üé® **Thi·∫øt K·∫ø Nh√£n Tr√™n Canvas**
            let ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // üî¢ **S·ªë th·ª© t·ª±**
            ctx.fillStyle = "black";
            ctx.font = "bold 40px Arial";
            ctx.fillText(counter, 700, 50);

            // üè∑Ô∏è **Th√¥ng tin SKU**
            ctx.font = "bold 30px Arial";
            ctx.fillText("SKU: " + sku, 30, 50);

            // üì¶ **T√™n s·∫£n ph·∫©m**
            ctx.font = "bold 30px Arial";
            ctx.fillStyle = "black";
            wrapText(ctx, "Name: " + sku_name, 30, 100, 785, 45, 3);

            // üìç **V·ªã tr√≠ trong kho**
            ctx.fillStyle = "black";
            ctx.font = "bold 40px Arial";
            ctx.fillText(location, 30, 235);

            // üî¢ **S·ªë l∆∞·ª£ng c·∫ßn pick**
            ctx.fillStyle = "black";
            ctx.font = "bold 100px Arial";
            ctx.fillText(qty, 520, 260);

            // üè∑Ô∏è **Lo·∫°i clearance**
            ctx.fillStyle = "black";
            ctx.font = "bold 24px Arial";
            ctx.fillText(type, 520, 350);

            // 3Ô∏è‚É£ **V·∫Ω Barcode**
            let barcodeImg = new Image();
            await new Promise(resolve => {
                barcodeImg.onload = resolve;
                barcodeImg.src = barcodeImage;
            });
            ctx.drawImage(barcodeImg, 30, 260, 400, 120);

            // 4Ô∏è‚É£ **Chuy·ªÉn Canvas Th√†nh ·∫¢nh V√† Nh√∫ng V√†o PDF**
            let imgBytes = canvas.toDataURL("image/png").split(",")[1];
            let imgBuffer = Uint8Array.from(atob(imgBytes), c => c.charCodeAt(0));
            let img = await pdfDoc.embedPng(imgBuffer);

            let page = pdfDoc.addPage([pdfWidth, pdfHeight]);
            page.drawImage(img, { x: 0, y: 0, width: pdfWidth, height: pdfHeight });

            counter++; // üî• **TƒÉng s·ªë th·ª© t·ª± sau m·ªói l·∫ßn l·∫∑p**
        }

        let pdfBytes = await pdfDoc.save();
        let blob = new Blob([pdfBytes], { type: "application/pdf" });
        let blobUrl = URL.createObjectURL(blob);

        let link = document.createElement("a");
        link.href = blobUrl;
        link.download = "Labels.pdf";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        setTimeout(() => {
            document.getElementById("progressModal").style.display = "none";
        }, 500);
    }



    // H√†m l·∫•y t·∫•t c·∫£ c√°c d√≤ng ƒëang hi·ªÉn th·ªã trong b·∫£ng
    function getDisplayedRows() {
        let table = document.getElementById("skuTable");
        let rows = table.getElementsByTagName("tr");
        let displayedRows = [];

        for (let i = 1; i < rows.length; i++) { // B·ªè qua ti√™u ƒë·ªÅ
            if (rows[i].style.display !== "none") { // Ch·ªâ l·∫•y c√°c d√≤ng hi·ªÉn th·ªã
                let cells = rows[i].getElementsByTagName("td");
                let rowData = [];
                for (let j = 0; j < cells.length; j++) { 
                    rowData.push(cells[j].textContent);
                }
                displayedRows.push(rowData);
            }
        }
        return displayedRows;
    }

    let plan_data = []
    let filteredData = []
    let lq_loc = ""

    async function load_data() {
        document.getElementById("loading").style.display = "block"; // Hi·ªÉn th·ªã loading

        return fetch('https://script.google.com/macros/s/AKfycbyfc7U2eV-KYc4EOp_6UIUzTT1V9xq3mXHtqHoP2MEBcKkn89oU-PFS3Khc24mSqU3A0g/exec')
            .then(res => res.json())
            .then(data => {
                plan_data = data.content;

                // Gi·ªØ nguy√™n c√°c c·ªôt b·∫Øt bu·ªôc
                let transformedData = plan_data.map(row => [row[0], row[4], row[7]]);
                let columnIndexToFilter;

                // X√°c ƒë·ªãnh c·ªôt c·∫ßn l·ªçc theo warehouse ƒë√£ ch·ªçn
                switch (selectedWarehouse) {
                    case "VNSC":
                        columnIndexToFilter = 10;
                        lq_loc = "VNSC-LQ-01-01-1-01";
                        break;
                    case "VNNC":
                        columnIndexToFilter = 11;
                        lq_loc = "VNNC-LQ-01-01-1-01";
                        break;
                    case "VNW":
                        columnIndexToFilter = 12;
                        lq_loc = "VNW-DI-02-01-2-12";
                        break;
                    case "VNC":
                        columnIndexToFilter = 13;
                        lq_loc = "VNC-LQ-01-01-1-01";
                        break;
                    default:
                        columnIndexToFilter = null;
                }

                // N·∫øu c√≥ c·ªôt c·∫ßn th√™m, th√¨ b·ªï sung v√†o transformedData
                if (columnIndexToFilter !== null) {
                    transformedData = transformedData.map((row, index) => [...row, plan_data[index][columnIndexToFilter]]);
                }

                // üî• **L·ªçc ch·ªâ l·∫•y nh·ªØng d√≤ng c√≥ gi√° tr·ªã > 0 ·ªü c·ªôt cu·ªëi c√πng**
                transformedData = transformedData.filter(row => row[row.length - 1] > 0);

                // üÜï **Th·ª±c hi·ªán Left Join v·ªõi d·ªØ li·ªáu Excel** (X·ª≠ l√Ω nhi·ªÅu d√≤ng kh·ªõp)
                let joinedData = [];
                
                transformedData.forEach(planRow => {
                    let matchingRows = excelData.filter(excelRow => excelRow[0] === planRow[0]); // L·ªçc t·∫•t c·∫£ d√≤ng kh·ªõp
                    
                    if (matchingRows.length > 0) {
                        matchingRows.forEach(match => {
                            joinedData.push([...planRow, ...match.slice(1)]); // Th√™m t·ª´ng d√≤ng tr√πng kh·ªõp v√†o
                        });
                    } else {
                        joinedData.push([...planRow, "", "", "", ""]); // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu trong Excel, ƒëi·ªÅn kho·∫£ng tr·ªëng
                    }
                });

                console.log("üìù D·ªØ li·ªáu sau khi JOIN:", joinedData);

                // üî• **L·ªçc ti·∫øp theo ƒëi·ªÅu ki·ªán: c·ªôt cu·ªëi c√πng ph·∫£i kh√°c r·ªóng**
                joinedData = joinedData.filter(row => row[row.length - 1] !== "");

                console.log("‚úÖ D·ªØ li·ªáu sau khi l·ªçc:", joinedData);

                // C·∫≠p nh·∫≠t b·∫£ng hi·ªÉn th·ªã
                loadTableData(joinedData);
                filterTable();
            })
            .catch(error => {
                alert("L·ªói khi t·∫£i d·ªØ li·ªáu: " + error);
            })
            .finally(() => {
                document.getElementById("loading").style.display = "none"; // ·∫®n loading
            });
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight, maxLines) {
        let words = text.split(" ");
        let line = "";
        let lines = [];

        for (let i = 0; i < words.length; i++) {
            let testLine = line + words[i] + " ";
            let testWidth = ctx.measureText(testLine).width;

            if (testWidth > maxWidth && i > 0) { 
                lines.push(line);
                line = words[i] + " ";
            } else {
                line = testLine;
            }
        }
        lines.push(line); // Th√™m d√≤ng cu·ªëi c√πng

        for (let i = 0; i < lines.length && i < maxLines; i++) {  // Gi·ªõi h·∫°n t·ªëi ƒëa 6 d√≤ng
            ctx.fillText(lines[i], x, y + (i * lineHeight));
        }
    }

    function generateBarcode(text, fontSize = 30) {
        let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");

        JsBarcode(svg, text, {
            format: "CODE128",
            displayValue: true, // Hi·ªÉn th·ªã gi√° tr·ªã d∆∞·ªõi barcode
            fontSize: fontSize, // K√≠ch th∆∞·ªõc ch·ªØ c·ªßa value
            // fontOptions: "bold", // L√†m ƒë·∫≠m ch·ªØ
            width: 2, // ƒê·ªô r·ªông v·∫°ch barcode
            // height: barcodeHeight, // Chi·ªÅu cao c·ªßa barcode
            margin: 10 // Kho·∫£ng c√°ch l·ªÅ
        });

        let xml = new XMLSerializer().serializeToString(svg);
        let svg64 = btoa(xml);
        return "data:image/svg+xml;base64," + svg64;
    }

    function handleFileUpload(event) {
        const file = event.target.files[0]; // L·∫•y file t·ª´ input
        if (!file) return;

        document.body.style.cursor = "progress"; // üî• ƒê·ªïi cursor th√†nh loading
        document.getElementById("loading").style.display = "block"; // Hi·ªÉn th·ªã hi·ªáu ·ª©ng loading

        const reader = new FileReader();
        reader.onload = function (e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });

            // L·∫•y sheet ƒë·∫ßu ti√™n
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];

            // Chuy·ªÉn sheet th√†nh m·∫£ng JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            // L·ªçc ch·ªâ gi·ªØ l·∫°i c√°c c·ªôt C (2), D (3), H (7), L (11), O (14)
            excelData = jsonData.map(row => [row[2], row[3], row[7], row[11], row[14]]);

            console.log("üìÇ D·ªØ li·ªáu t·ª´ file Excel:", excelData);
        };

        reader.onloadend = function () {
            confirmWarehouse()
        };

        reader.readAsArrayBuffer(file);
    }

    </script>

</body>
</html>
