<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>[NEW] - Surplus</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div id="loader2" class="loader-container">
    <div class="spinner"></div>
    <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
  </div>

  <!-- <input type="file" id="excelFileInput" />
  <button onclick="uploadExcel()">Upload</button> -->

  <div id="whs-modal">
    <div id="whs-modal-content">
      <h2>Ch·ªçn Warehouse ID</h2>
      <select id="whs-select">
        <option value="">-- Ch·ªçn WHS ID --</option>
        <option value="VNS">VNS</option>
        <option value="VNSC">VNSC</option>
        <option value="VNN">VNN</option>
        <option value="VNNC">VNNC</option>
        <option value="VNW">VNW</option>
        <option value="VNC">VNC</option>
      </select>
    </div>
  </div>

  <div id="action-selection" class="hidden">
    <h3>Ch·ªçn thao t√°c</h3>
    <button onclick="showForm('nhap')">Nh·∫≠p</button>
    <button onclick="showForm('xuat')">Xu·∫•t</button>
    <button onclick="showForm('transaction')">Transaction</button>
    <button onclick="showForm('add-location')">Th√™m Location</button>
    <button onclick="showForm('dashboard-frame')">Dashboard</button>
  </div>

  <div style="display: flex; gap: 20px; align-items: flex-start;">
    <div id="nhap-form" class="form-section hidden" style="flex: 1;">
      <h2>NH·∫¨P SURPLUS</h2>
      <label for="operator">Operator</label>
      <input type="text" id="operator" />

      <label for="sku">SKU ID / UPC</label>
      <input type="text" id="sku" onkeydown="handleSkuEnter(event)" />

      <label for="quantity">Quantity</label>
      <input type="number" id="quantity" value="1"/>

      <label for="location">Location</label>
      <input type="text" id="location" />

      <button onclick="submitNhap()">L∆∞u</button>
    </div>

    <div id="result-frame" class="form-section hidden" style="flex: 1;">
      <h2>TH√îNG TIN SKU</h2>
      <div id="sku_id_founded"></div>
      <div id="sku_name_founded"></div>
      <div id="zones_founded"></div>
      <h3 style="margin-top: 30px;">T·ªìn kho Surplus</h3>
      <div id="table_onhand_result2"></div>
    </div>
  </div>

  <div style="display: flex; gap: 20px; align-items: flex-start;">
    <div id="xuat-form" class="form-section hidden" style="flex: 1;">
      <h2>XU·∫§T SURPLUS</h2>
      <label for="operator_export">Operator</label>
      <input type="text" id="operator_export" />
  
      <label for="sku_export">SKU ID / UPC</label>
      <input type="text" id="sku_export" onkeydown="handleExportSkuEnter(event)" />
  
      <label for="quantity_export">Quantity</label>
      <input type="number" id="quantity_export" value="1" />
  
      <label for="location_export">Location</label>
      <input type="text" id="location_export" />
  
      <button onclick="submitXuat()">L∆∞u</button>
    </div>
  
    <div id="result-frame-export" class="form-section hidden" style="flex: 1;">
      <h2>ONHAND T·ªíN KHO</h2>
      <div id="sku_id_founded_export"></div>
      <div id="sku_name_founded_export"></div>
      <div id="table_onhand_result"></div>
    </div>
  </div>

  <div style="margin-top: 60px;">
    <div id="transaction-frame" class="form-section hidden">
      <h2>L·ªäCH S·ª¨ TRANSACTION</h2>
      <label for="transaction-type">Lo·∫°i giao d·ªãch</label>
      <select id="transaction-type" onchange="loadTransactionData()">
        <option value="">-- Ch·ªçn lo·∫°i --</option>
        <option value="import">Nh·∫≠p</option>
        <option value="export">Xu·∫•t</option>
        <option value="onhand">T·ªìn kho</option>
      </select>
      <button onclick="exportToExcelXLSX()" style="margin-top: 12px;">üì§ Xu·∫•t Excel</button>
      <div id="transaction-table" style="margin-top: 20px;"></div>
    </div>
  </div>

  <div style="margin-top: 60px;">
    <div id="add-location-frame" class="form-section hidden">
      <h2>TH√äM SURPLUS LOCATION</h2>
      <input type="file" id="location-excel-file" accept=".xlsx" class="upload-input"/>
      <button onclick="uploadLocationFile()">T·∫£i l√™n v√† l∆∞u</button>
    </div>
  </div>

  <!-- Dashboard Section -->
  <div id="dashboard-frame" class="form-section hidden" style="margin-top: 60px;">
    <h2>DASHBOARD T·ªíN KHO</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px;">
      <div class="dashboard-card">
        <h3>Nh·∫≠p</h3>
        <p id="dashboard-import-total"><span class="big-number">...</span> <span class="unit-label">item</span></p>
      </div>
      
      <div class="dashboard-card">
        <h3>Xu·∫•t</h3>
        <p id="dashboard-export-total"><span class="big-number">...</span> <span class="unit-label">item</span></p>
      </div>
      
      <div class="dashboard-card">
        <h3>T·ªìn</h3>
        <p id="dashboard-onhand-total"><span class="big-number">...</span> <span class="unit-label">item</span></p>
      </div>
    </div>
    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px;">
      <div class="dashboard-card">
        <h3>Nh·∫≠p</h3>
        <p id="dashboard-import-skus"><span class="big-number">...</span> <span class="unit-label">SKU</span></p>
      </div>
      
      <div class="dashboard-card">
        <h3>Xu·∫•t</h3>
        <p id="dashboard-export-skus"><span class="big-number">...</span> <span class="unit-label">SKU</span></p>
      </div>
      
      <div class="dashboard-card">
        <h3>T·ªìn</h3>
        <p id="dashboard-onhand-skus"><span class="big-number">...</span> <span class="unit-label">SKU</span></p>
      </div>
    </div>

    <div style="margin-top: 40px;">
      <h3>Chi ti·∫øt t·ªìn kho</h3>
      <div id="dashboard-onhand-table"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>



  <script>
    let selectedWHS = "";
    let cookie_arr = [];
    let backendBaseUrl = "";
    let cookie = '';
    let location_list = [];
    
    async function loadLocation() {
      try {
        const res = await fetch(backendBaseUrl + "/api/load-location-list", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({})
        });

        const data = await res.json();

        if (data?.success && Array.isArray(data.location_list)) {
          location_list = data.location_list;
          console.log("üìç Danh s√°ch location ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t:", location_list);
        } else {
          console.warn("‚ö†Ô∏è Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t location_list t·ª´ server");
        }
      } catch (err) {
        console.error("‚ùå L·ªói khi t·∫£i location_list:", err);
      }
    }

    async function loadCookieArray() {
      const url = "https://script.google.com/macros/s/AKfycbw4AykhEv2AmxCt_23XJGB7Rt1zzchWqKF7RinMWnTKTG9UG8h2tk99SjHsLnZkU8Cn/exec";
      try {
        const res = await fetch(url);
        cookie_arr = await res.json();
        backendBaseUrl = cookie_arr[11][1];
        cookie = cookie_arr[0][1];
        loadLocation()
        hideLoader();
      } catch (err) {
        document.getElementById('loader2').innerHTML = "<p style='color:red;'>‚ùå L·ªói t·∫£i cookie_arr</p>";
      }
    }

    function hideLoader() {
      document.getElementById('loader2').classList.add('hidden');
    }

    loadCookieArray();

    document.getElementById('whs-select').addEventListener('change', function() {
      selectedWHS = this.value;
      if (selectedWHS) {
        document.getElementById('whs-modal').classList.add('hidden');
        document.getElementById('action-selection').classList.remove('hidden');
      }
    });

    function showForm(action) {
      // ·∫®n t·∫•t c·∫£ c√°c frame
      document.getElementById('nhap-form')?.classList.add('hidden');
      document.getElementById('result-frame')?.classList.add('hidden');
      document.getElementById('xuat-form')?.classList.add('hidden');
      document.getElementById('result-frame-export')?.classList.add('hidden');
      document.getElementById('transaction-frame')?.classList.add('hidden');
      document.getElementById('add-location-frame')?.classList.add('hidden');
      document.getElementById('dashboard-frame')?.classList.add('hidden');
      

      // Hi·ªán frame t∆∞∆°ng ·ª©ng
      if (action === 'nhap') {
        document.getElementById('nhap-form').classList.remove('hidden');
        document.getElementById('result-frame').classList.remove('hidden');
      } else if (action === 'xuat') {
        document.getElementById('xuat-form').classList.remove('hidden');
        document.getElementById('result-frame-export').classList.remove('hidden');
      } else if (action === 'transaction') {
        document.getElementById('transaction-frame').classList.remove('hidden');
      } else if (action === 'add-location') {
        document.getElementById('add-location-frame').classList.remove('hidden');
      } else if (action === 'dashboard-frame') {
        document.getElementById('dashboard-frame').classList.remove('hidden');
        loadDashboard();
      }

    }

    async function handleSkuEnter(event) {
      if (event.key === 'Enter') {
        const sku = event.target.value.trim();

        const whValue = document.getElementById('whs-select').value;
        const found = cookie_arr.find(row => row[0] === whValue);
        if (!found) return alert("WH kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng t√¨m th·∫•y cookie");

        cookie = found[1].replace(/ /g, "");
        if (!sku || !cookie) return;

        try {
          const res = await fetch(backendBaseUrl + "/api/surplus-search-onhand", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ search: sku, cookie })
          });
          const data = await res.json();
          console.log("D·ªØ li·ªáu t√¨m ki·∫øm SKU:", data);

          if (data?.sku_id) {
            document.getElementById('sku_id_founded').innerHTML = `<strong>SKU ID:</strong> ${data.sku_id}`;
            document.getElementById('sku_name_founded').innerHTML = `<strong>SKU Name:</strong> ${data.sku_name}`;
            document.getElementById('zones_founded').innerHTML = `<strong>Zones:</strong> ${data.zones}`;

            const zonesText = data.zones;
            const highlightZones = ["MS", "DO", "AV"];
            const shouldHighlight = highlightZones.some(zone => zonesText.includes(zone));

            const zoneDiv = document.getElementById('zones_founded');
            // zoneDiv.innerHTML = `<strong>Zones:</strong> ${zonesText}`;
            zoneDiv.classList.toggle('highlight-zone', shouldHighlight);

          } else {
            document.getElementById('sku_id_founded').innerHTML =
            document.getElementById('sku_name_founded').innerHTML =
            document.getElementById('zones_founded').innerHTML = "";
            document.getElementById('zones_founded').innerText = "Kh√¥ng t√¨m th·∫•y SKU tr√™n H·ªá th·ªëng";
          }
        } catch (err) {
          document.getElementById('result-box').innerText = 'L·ªói khi fetch d·ªØ li·ªáu t·ª´ server';
        }

        const res2 = await fetch(backendBaseUrl + "/api/surplus-check-onhand", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ whs: whValue, sku: sku })
          });

          const data = await res2.json();
          onhandCheck = data;

          if (Array.isArray(data) && data.length > 0) {
            let html = `<table style='width:100%; border-collapse: collapse;'>
              <thead><tr><th>Location</th><th>Onhand</th></tr></thead><tbody>`;
            for (const row of data) {
              html += `<tr><td>${row.actual_location}</td><td>${row.onhand_quantity}</td></tr>`;
            }
            html += `</tbody></table>`;
            document.getElementById("table_onhand_result2").innerHTML = html;
            
          } else {
            document.getElementById("table_onhand_result2").innerHTML = `<p style='color:red;'>Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn kho trong Surplus</p>`;
          }
      }
    }

    async function submitNhap() {
      const operator = document.getElementById('operator').value;
      const sku = document.getElementById('sku').value;
      const quantity = document.getElementById('quantity').value;
      const location = document.getElementById('location').value.trim();

      if (!operator) {
        alert("‚ùå Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi th·ª±c hi·ªán.");
        document.getElementById('operator').focus();
        return;
      }

      if (!sku) {
        alert("‚ùå Vui l√≤ng nh·∫≠p SKU ID / UPC.");
        document.getElementById('sku').focus();
        return;
      }

      if (!quantity || isNaN(quantity) || quantity <= 0) {
        alert("‚ùå S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá.");
        document.getElementById('quantity').value = "1";
        document.getElementById('quantity').focus();
        return;
      }

      if (!location_list.includes(location)) {
        alert("‚ùå Location kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng c√≥ trong danh s√°ch.");
        document.getElementById('location').value = "";
        document.getElementById('location').focus();
        return;
      }

      const payload = {
        whs: selectedWHS,
        operator,
        sku_id: document.getElementById('sku_id_founded').innerText.replace("SKU ID: ", ""),
        sku_name: document.getElementById('sku_name_founded').innerText.replace("SKU Name: ", ""),
        quantity,
        location
      };

      try {
        const response = await fetch(backendBaseUrl + "/api/surplus-save-import", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (response.ok) {
          alert("‚úÖ L∆∞u th√†nh c√¥ng!");
          resetFormNhap();
        } else {
          alert("‚ùå L·ªói khi l∆∞u: " + (result.error || "Kh√¥ng r√µ l·ªói"));
        }
      } catch (err) {
        alert("‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c t·ªõi server.");
        console.error(err);
      }
    }


    function resetFormNhap() {
      document.getElementById('sku').value = "";
      document.getElementById('quantity').value = "1";
      document.getElementById('location').value = "";

      document.getElementById('sku_id_founded').innerHTML = "";
      document.getElementById('sku_name_founded').innerHTML = "";
      document.getElementById('zones_founded').innerHTML = "";

      document.getElementById('sku').focus();    }

    // Xu·∫•t h√†ng

    let onhandCheck = null;

    async function handleExportSkuEnter(event) {
      if (event.key === 'Enter') {
        const search = event.target.value.trim();
        const whValue = selectedWHS;

        const found = cookie_arr.find(row => row[0] === whValue);
        if (!found) return alert("WH kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng t√¨m th·∫•y cookie");
        const cookie = found[1].replace(/ /g, "");

        try {
          // B∆∞·ªõc 1: g·ªçi API ƒë·ªÉ l·∫•y sku_id
          const res1 = await fetch(backendBaseUrl + "/api/search-onhand", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ search, cookie })
          });

          const { sku_id } = await res1.json();
          console.log("SKU ID:", sku_id);
          if (!sku_id) {
            alert("‚ùå Kh√¥ng t√¨m th·∫•y SKU ID");
            document.getElementById("sku_id_founded_export").innerHTML = "";
            document.getElementById("sku_name_founded_export").innerHTML = "";
            document.getElementById("table_onhand_result").innerHTML = "";

            document.getElementById("sku_export").value = "";
            document.getElementById("sku_export").focus();
            return;
          }


          // B∆∞·ªõc 2: g·ªçi t·ªõi view onhand
          const res2 = await fetch(backendBaseUrl + "/api/surplus-check-onhand", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ whs: whValue, sku: sku_id })
          });

          const data = await res2.json();
          onhandCheck = data;

          if (Array.isArray(data) && data.length > 0) {
            let html = `<table style='width:100%; border-collapse: collapse;'>
              <thead><tr><th>Location</th><th>Onhand</th></tr></thead><tbody>`;
            for (const row of data) {
              html += `<tr><td>${row.actual_location}</td><td>${row.onhand_quantity}</td></tr>`;
            }
            html += `</tbody></table>`;
            document.getElementById("table_onhand_result").innerHTML = html;
            
          } else {
            document.getElementById("table_onhand_result").innerHTML = `<p style='color:red;'>Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn kho</p>`;
          }

          document.getElementById("sku_id_founded_export").innerHTML = `<strong>SKU ID:</strong> ${sku_id}`;
          document.getElementById("sku_name_founded_export").innerHTML = `<strong>SKU Name:</strong> ${data[0].sku_name}`;

        } catch (err) {
          console.error("‚ùå L·ªói khi x·ª≠ l√Ω SKU:", err);
        }
      }
    }

    async function submitXuat() {
      const operator = document.getElementById('operator_export').value;
      const sku = document.getElementById('sku_export').value.trim();
      const quantity = parseInt(document.getElementById('quantity_export').value);
      const location = document.getElementById('location_export').value.trim();

      if (!operator) {
        alert("‚ùå Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi th·ª±c hi·ªán.");
        document.getElementById('operator_export').focus();
        return;
      }

      if (!onhandCheck || onhandCheck.length === 0) {
        alert("‚ùå Ch∆∞a c√≥ d·ªØ li·ªáu t·ªìn kho ƒë·ªÉ so s√°nh");
        return;
      }

      const matched = onhandCheck.find(row => row.actual_location === location);
      if (!matched) {
        alert("‚ùå Location kh√¥ng kh·ªõp v·ªõi v·ªã tr√≠ ch·ª©a hi·ªán t·∫°i");
        return;
      }

      if (quantity > matched.onhand_quantity) {
        alert("‚ùå S·ªë l∆∞·ª£ng xu·∫•t v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng t·ªìn kho hi·ªán t·∫°i");
        return;
      }

      const payload = {
        whs: selectedWHS,
        operator,
        location,
        sku_id: matched.sku_id,
        sku_name: matched.sku_name,
        quantity
      };

      try {
        const res = await fetch(backendBaseUrl + "/api/surplus-save-export", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await res.json();
        if (res.ok) {
          alert("‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng!");
          resetFormXuat();
        } else {
          alert("‚ùå L·ªói khi l∆∞u: " + (result.error || "Kh√¥ng r√µ l·ªói"));
        }
      } catch (err) {
        alert("‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c t·ªõi server.");
        console.error(err);
      }
    }

    function resetFormXuat() {
      document.getElementById('sku_export').value = "";
      document.getElementById('quantity_export').value = 1;
      document.getElementById('location_export').value = "";
      document.getElementById('operator_export').value = "";
      document.getElementById("sku_id_founded_export").innerHTML = "";
      document.getElementById("sku_name_founded_export").innerHTML = "";
      document.getElementById("table_onhand_result").innerHTML = "";
      document.getElementById("sku_export").focus();
    }
    let latestTransactionData = [];

    async function loadTransactionData() {
      const type = document.getElementById('transaction-type').value;
      if (!type || !selectedWHS) return;

      try {
        const res = await fetch(backendBaseUrl + "/api/transaction-history", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type, whs: selectedWHS })
        });

        const data = await res.json();
        latestTransactionData = data;

        if (!Array.isArray(data) || data.length === 0) {
          document.getElementById('transaction-table').innerHTML = '<p style="color:red;">Kh√¥ng c√≥ d·ªØ li·ªáu</p>';
          return;
        }

        let html = '<table><thead><tr>';
        Object.keys(data[0]).forEach(key => {
          html += `<th>${key}</th>`;
        });
        html += '</tr></thead><tbody>';

        for (const row of data) {
          html += '<tr>';
          for (const key in row) {
            html += `<td>${row[key]}</td>`;
          }
          html += '</tr>';
        }

        html += '</tbody></table>';
        document.getElementById('transaction-table').innerHTML = html;
      } catch (err) {
        document.getElementById('transaction-table').innerHTML = '<p style="color:red;">L·ªói khi t·∫£i d·ªØ li·ªáu</p>';
        console.error("‚ùå L·ªói khi t·∫£i transaction:", err);
      }
    }

    function exportToExcelXLSX() {
      if (!latestTransactionData.length) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t");

      const worksheet = XLSX.utils.json_to_sheet(latestTransactionData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Transaction");

      XLSX.writeFile(workbook, `transaction_export_${Date.now()}.xlsx`);
    }

    async function uploadLocationFile() {
      const input = document.getElementById('location-excel-file');
      const file = input.files[0];
      if (!file) return alert("Vui l√≤ng ch·ªçn file Excel");

      const reader = new FileReader();
      reader.onload = async function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        // L·∫•y danh s√°ch t·ª´ c·ªôt ƒë·∫ßu ti√™n, kh√¥ng c√≥ ti√™u ƒë·ªÅ
        const locationList = json.map(row => row[0]).filter(x => typeof x === 'string' && x.trim());

        if (!locationList.length) return alert("File kh√¥ng c√≥ d·ªØ li·ªáu location h·ª£p l·ªá");

        try {
          const res = await fetch(backendBaseUrl + "/api/surplus-add-location", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ locations: locationList })
          });

          const data = await res.json();
          if (res.ok) {
            alert("‚úÖ ƒê√£ th√™m th√†nh c√¥ng " + data.inserted + " location m·ªõi");
            loadLocation();
          } else {
            alert("‚ùå Th√™m location th·∫•t b·∫°i: " + (data.error || "Kh√¥ng r√µ l·ªói"));
          }
        } catch (err) {
          alert("‚ùå L·ªói khi g·ª≠i file v·ªÅ server");
          console.error(err);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    async function loadDashboard() {
      if (!selectedWHS) return;
      try {
        const res = await fetch(backendBaseUrl + "/api/dashboard-summary", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ whs: selectedWHS })
        });
        const data = await res.json();

        document.getElementById('dashboard-import-total').querySelector('.big-number').textContent = data.import ?? '0';
        document.getElementById('dashboard-export-total').querySelector('.big-number').textContent = data.export ?? '0';
        document.getElementById('dashboard-onhand-total').querySelector('.big-number').textContent = data.onhand ?? '0';
        document.getElementById('dashboard-import-skus').querySelector('.big-number').textContent = data.import_skus ?? '0';
        document.getElementById('dashboard-export-skus').querySelector('.big-number').textContent = data.export_skus ?? '0';
        document.getElementById('dashboard-onhand-skus').querySelector('.big-number').textContent = data.onhand_skus ?? '0';

        if (Array.isArray(data.onhand_detail)) {
          let html = '<table><thead><tr>';
          html += '<th>SKU</th><th>T√™n</th><th>Location</th><th>S·ªë l∆∞·ª£ng</th>';
          html += '</tr></thead><tbody>';
          for (const row of data.onhand_detail) {
            html += `<tr><td>${row.sku_id}</td><td>${row.sku_name}</td><td>${row.actual_location}</td><td>${row.onhand_quantity}</td></tr>`;
          }
          html += '</tbody></table>';
          document.getElementById('dashboard-onhand-table').innerHTML = html;
        } else {
          document.getElementById('dashboard-onhand-table').innerHTML = '<p style="color:red;">Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn kho</p>';
        }
      } catch (err) {
        console.error("‚ùå L·ªói khi load dashboard:", err);
      }
    }

    async function uploadExcel() {
      const fileInput = document.getElementById('excelFileInput');
      const file = fileInput.files[0];
      if (!file) {
        alert("Vui l√≤ng ch·ªçn m·ªôt file Excel.");
        return;
      }

      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data);
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      console.log("D·ªØ li·ªáu t·ª´ file Excel:", rows);

      // B·ªè qua h√†ng ti√™u ƒë·ªÅ
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        console.log("D√≤ng " + (i + 1) + ": ", row);
        const payload = {
          whs: row[0],
          operator: row[1],
          sku_id: row[2],
          sku_name: row[3],
          quantity: row[4],
          location: row[5]
        };

        try {
          const response = await fetch(backendBaseUrl + "/api/surplus-save-import", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
          });

          const result = await response.json();
          if (!response.ok) {
            console.error("‚ùå L·ªói khi l∆∞u d√≤ng " + (i + 1) + ": ", result.error || "Kh√¥ng r√µ l·ªói");
          }
        } catch (err) {
          console.error("‚ùå Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c t·ªõi server cho d√≤ng " + (i + 1), err);
        }
      }

      alert("‚úÖ Upload ho√†n t·∫•t!");
    }
  </script>
</body>
</html>
