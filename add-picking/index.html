<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Picking</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>


</head>
<body>
  <h1>Add Picking Print</h1>
  <div>
    <label for="whSelect">Chọn WH:</label>
    <select id="whSelect">
      <option value="VNS">VNS</option>
      <option value="VNSC">VNSC</option>
      <option value="VNN">VNN</option>
      <option value="VNNC">VNNC</option>
      <option value="VNW">VNW</option>
    </select>
  </div>

  <div>
    <input type="text" id="searchInput" placeholder="Nhập đơn hàng" onkeydown="if(event.key === 'Enter') search()" />
    <button onclick="search()">Tìm kiếm</button>
  </div>

  <div id="result">
    <p id="subIdResult"></p>
    <p id="skuIdResult"></p>
    <p id="skuNameResult"></p>
    <p id="locResult"></p>
    <p id="qtyResult"></p>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h3>Nhập Grid No</h3>
      <input type="text" id="gridInput" placeholder="Nhập Grid No" onkeydown="if(event.key === 'Enter') printLabel()"/>
      <button onclick="printLabel()">In Label</button>
    </div>
  </div>

  <div style="display:none">
    <canvas id="labelCanvas" width="288" height="144"></canvas>
  </div>

  <div id="loader">
    <div class="spinner"></div>
    <p>Đang tải dữ liệu... Vui lòng chờ</p>
  </div>
  

  <script>
    let backendBaseUrl = ""; // ⚠️ Thay bằng ngrok/IP nếu dùng từ Render

    let cookie_arr = [];

    async function loadCookieArray() {
      const url = "https://script.google.com/macros/s/AKfycbw4AykhEv2AmxCt_23XJGB7Rt1zzchWqKF7RinMWnTKTG9UG8h2tk99SjHsLnZkU8Cn/exec";
      try {
        const res = await fetch(url);
        cookie_arr = await res.json();
        backendBaseUrl = cookie_arr[11][1]; // Lấy backendBaseUrl từ cookie_arr
        console.log("Backend Base URL:", backendBaseUrl);
        document.getElementById('loader').style.display = 'none';
      } catch (err) {
        document.getElementById('loader').innerHTML = "<p style='color:red;'>❌ Lỗi tải cookie_arr</p>";
      }
    }

    loadCookieArray();

    let currentData = null;

    async function search() {
      const searchKey = document.getElementById('searchInput').value.trim();
      const whValue = document.getElementById('whSelect').value;

      if (!searchKey) return alert("Vui lòng nhập mã OB");

      const found = cookie_arr.find(row => row[0] === whValue);
      if (!found) return alert("WH không hợp lệ hoặc không tìm thấy cookie");

      const cookieValue = found[1].replace(/ /g, "");

      try {
        const res = await fetch(`${backendBaseUrl}/api/data`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ search: searchKey, cookie: cookieValue })
        });

        const data = await res.json();

        if (data.sub_pickup_id && data.skus.length === 1) {
          const item = data.skus[0];
          currentData = { ...item, searchKey, sub_pickup_id: data.sub_pickup_id };

          document.getElementById('subIdResult').textContent = `✅ Sub Pickup ID: ${data.sub_pickup_id}`;
          document.getElementById('skuIdResult').textContent = `SKU ID: ${item.sku_id}`;
          document.getElementById('skuNameResult').textContent = `Tên SKU: ${item.sku_name}`;
          document.getElementById('locResult').textContent = `Vị trí gợi ý: ${item.suggest_locations}`;
          document.getElementById('qtyResult').textContent = `Tổng số lượng: ${item.total_quantity}`;

          document.getElementById('modal').style.display = 'flex';
          document.getElementById('gridInput').value = '';
          document.getElementById('gridInput').focus();
        } else {
          alert("Không tìm thấy hoặc có nhiều hơn 1 dòng dữ liệu!");
        }
      } catch (err) {
        alert("Lỗi khi gọi API nội bộ");
        console.error(err);
      }
    }

    function printLabel() {
      const gridNo = document.getElementById('gridInput').value.trim();
      if (!gridNo) {
        alert("Vui lòng nhập Grid No");
        document.getElementById('gridInput').focus();
        return;
      }

      const canvas = document.getElementById('labelCanvas');
      canvas.width = 396;
      canvas.height = 559;
      const ctx = canvas.getContext('2d');

      // Reset canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#fff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#000";

      const padX = 20;
      let y = 20;

      // Tạo QR code vào canvas phụ
      const qrCanvas = document.createElement('canvas');
      QRCode.toCanvas(qrCanvas, currentData.searchKey, {
        width: 120,
        margin: 1
      }, function (error) {
        if (error) {
          console.error(error);
          return;
        }

        ctx.drawImage(qrCanvas, 110, y);
        y += 160;
        ctx.font = "bold 22px Arial";
        ctx.fillText(`${currentData.searchKey}`, padX, y);

        y += 30
        // Grid No - đậm và to hơn
        ctx.font = "bold 22px Arial";
        ctx.fillText(`Grid No: ${gridNo}`, padX, y);
        y += 36;

        // SKU Name
        ctx.font = "18px Arial";
        const skuName = currentData.sku_name;
        const maxWidth = canvas.width - padX * 2;
        const lineHeight = 20;
        let words = skuName.split(" ");
        let line = "";
        let lines = [];

        for (let n = 0; n < words.length; n++) {
          let testLine = line + words[n] + " ";
          let metrics = ctx.measureText(testLine);
          if (metrics.width > maxWidth && n > 0) {
            lines.push(line.trim());
            line = words[n] + " ";
          } else {
            line = testLine;
          }
        }
        lines.push(line.trim());
        lines = lines.slice(0, 4);

        for (let l of lines) {
          ctx.fillText(l, padX, y);
          y += lineHeight;
        }

        y += 45;
        ctx.fillText(`Location: ${currentData.suggest_locations}`, padX, y); y += 24;
        ctx.fillText(`Quantity: ${currentData.total_quantity}`, padX, y);

        // In canvas
        const dataUrl = canvas.toDataURL();
        const win = window.open('', '_blank');
        win.document.write(`<img src="${dataUrl}" onload="window.print(); window.close()" />`);
        win.document.close();

        document.getElementById('modal').style.display = 'none';
        document.getElementById('searchInput').value = '';
        document.getElementById('searchInput').focus();
      });
    }

  </script>
</body>
</html>
