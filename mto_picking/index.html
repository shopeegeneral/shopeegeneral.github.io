from selenium import webdriver
from selenium.webdriver.common.by import By
import time
import os
import gspread
import pandas as pd
import zipfile
import shutil
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.keys import Keys
from python_calamine import CalamineWorkbook
from datetime import datetime
import requests
import json
from bs4 import BeautifulSoup
import math

def mtp_picking(whs_id):
    df_mt_final = pd.DataFrame()
    wh_list = [whs_id]

    email_log = '4229'
    pass_log = 'Aa123456@.'

    chrome_driver_path = r"C:\Users\hau.giang\Desktop\MTO Picking\chromedriver-win64\chromedriver.exe"  # Đổi thành đường dẫn thực tế của bạn

    # Tạo một Service object và truyền vào WebDriver
    service = Service(chrome_driver_path)
    driver = webdriver.Chrome(service=service)

    # driver = webdriver.Chrome()
    wait = WebDriverWait(driver, 60)
    # driver = webdriver.Chrome()
    url = 'https://wms.business.accounts.shopee.com/authenticate/login?lang=en&client_id=19&next=https%3A%2F%2Fwms.ssc.shopee.vn%2Fv2%2Ftob%2Fcallback&google_login_redirect=https%3A%2F%2Fwms.ssc.shopee.vn%2Fv2%2Fgoogle%2Flogin'
    driver.get(url)
    driver.maximize_window()

    # Tạo một instance của WebDriverWait với thời gian chờ là 60 giây

    # Tìm phần tử user_name và nhập email
    # user_name = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, '.ssc-input input')))
    time.sleep(1)
    user_name = wait.until(EC.presence_of_element_located((By.XPATH, '/html/body/div[1]/div/div[2]/div/div/div/div[3]/form/div/div/div[1]/div/input')))
    user_name.send_keys(email_log)

    pass_word = driver.find_element(By.XPATH, '/html/body/div[1]/div/div[2]/div/div/div/div[3]/form/div/div/div[2]/div/input')
    pass_word.send_keys(pass_log)
    pass_word.send_keys(Keys.ENTER)
                        
    time.sleep(1)
    choose_wh = wait.until(EC.presence_of_element_located((By.XPATH, '//*[@id="app"]/div[1]/div[1]/section[1]/span/span[1]/div/div/span[1]/span/input')))
    if choose_wh:
        pass
    else:
        user_name = wait.until(EC.presence_of_element_located((By.XPATH, '/html/body/div[1]/div/div[2]/div/div/div/div[3]/form/div/div/div[1]/div/input')))
        user_name.send_keys(email_log)

        pass_word = driver.find_element(By.XPATH, '/html/body/div[1]/div/div[2]/div/div/div/div[3]/form/div/div/div[2]/div/input')
        pass_word.send_keys(pass_log)
        pass_word.send_keys(Keys.ENTER)
        time.sleep(1)

    df_mto = pd.DataFrame()
    for wh in wh_list:
        #Choose WH
        choose_wh = wait.until(EC.presence_of_element_located((By.XPATH, '//*[@id="app"]/div[1]/div[1]/section[1]/span/span[1]/div/div/span[1]/span/input')))
        choose_wh.click()
        time.sleep(1)

        wh_list = wait.until(EC.presence_of_element_located((By.XPATH, '/html/body/span/div/div/div/ul')))
        wh_list = wh_list.text
        wh_list = wh_list.split('\n')

        wh_name = 'VN - ' + wh
        wh_click =  int(wh_list.index(wh_name) + 1)
        wh_list
        vns = driver.find_element(By.XPATH, f'/html/body/span/div/div/div/ul/li[{str(wh_click)}]/span').click()
        time.sleep(1)
        check = wait.until(EC.presence_of_element_located((By.XPATH, '//*[@id="app"]/div[1]/div[1]/section[1]/span/span[1]/div/div/span[1]/span/input')))

        status_list = [0]
        picking_id_list = []

        for i in status_list:
            try:
                driver.get(f"https://wms.ssc.shopee.vn/api/v2/apps/process/taskcenter/mtopicktask/search_mto_picking_task?picking_task_status={str(i)}&pageno=1&count=1000")
                time.sleep(0.5)
                page_content = driver.page_source

                soup = BeautifulSoup(page_content, 'html.parser')

                # Tìm thẻ <pre> và lấy nội dung
                pre_content = soup.find('pre').text

                parse_data = json.loads(pre_content)['data']['list']
                df = pd.DataFrame(parse_data)[['pickup_id','mto_order_no']]
                picking_id_list.append(df)
            except:
                continue

        try: 
            df_mt = pd.concat(picking_id_list,ignore_index=True)
        except:
            driver.get('https://wms.ssc.shopee.vn/v2/moveinbound/order')
            time.sleep(1)
            df_mt = pd.DataFrame()

    print(df_mt)
    if len(df_mt) == 0:
        return df_mt_final
    
    detail_mt = []
    for index, row in df_mt.iterrows():

        try:
            driver.get(f"https://wms.ssc.shopee.vn/api/v2/apps/process/taskcenter/mtopicktask/get_mto_picking_sku_list?pickup_id={row['pickup_id']}&pageno=1&count=100")
            time.sleep(0.5)
            page_content = driver.page_source
            soup = BeautifulSoup(page_content, 'html.parser')

            # Tìm thẻ <pre> và lấy nội dung
            pre_content = soup.find('pre').text

            parse_data = json.loads(pre_content)['data']['list']
            df = pd.DataFrame(parse_data)[['sku_id','sku_name','suggest_locations','total_quantity']]

            df['pickup_id'] = row['pickup_id']
            df['mto_order_no'] = row['mto_order_no']
            detail_mt.append(df)
        except:
            continue
    
    df_mt_final = pd.concat(detail_mt,ignore_index=True)
    df_mt_final['whs_id'] = wh

    df_mt_final['suggest_locations'] = df_mt_final['suggest_locations'].apply(lambda x: x[0] if isinstance(x, list) and x else None)

    # driver.get('https://wms.ssc.shopee.vn/v2/moveinbound/order')
    # time.sleep(1)
    
    df_to_whs_list = []
    try:
        driver.get(f"https://wms.ssc.shopee.vn/api/v2/apps/process/outbound/mtoorder/search_move_transfer_order?status=130&is_create_time_asc=0&pageno=1&count=20")
        time.sleep(0.5)
        page_content = driver.page_source
        soup = BeautifulSoup(page_content, 'html.parser')

        # Tìm thẻ <pre> và lấy nội dung
        pre_content = soup.find('pre').text

        total = json.loads(pre_content)['data']['total']
        page_count = math.ceil(total/200)
        print(page_count)
    except Exception as e:
        page_count = 0

    if page_count > 0:
        for i in range(1,page_count + 1):
            driver.get(f"https://wms.ssc.shopee.vn/api/v2/apps/process/outbound/mtoorder/search_move_transfer_order?status=130&is_create_time_asc=0&pageno={str(i)}&count=200")
            time.sleep(0.5)
            page_content = driver.page_source
            soup = BeautifulSoup(page_content, 'html.parser')

            # Tìm thẻ <pre> và lấy nội dung
            pre_content = soup.find('pre').text

            parse_data = json.loads(pre_content)['data']['list']
            df_obding = pd.DataFrame(parse_data)[['mto_order_no','to_whs_id']]
            df_to_whs_list.append(df_obding)
    else:
        df_obding = pd.DataFrame()

    try:
        driver.get(f"https://wms.ssc.shopee.vn/api/v2/apps/process/outbound/mtoorder/search_move_transfer_order?status=20&is_create_time_asc=0&pageno=1&count=20")
        time.sleep(0.5)
        page_content = driver.page_source
        soup = BeautifulSoup(page_content, 'html.parser')

        # Tìm thẻ <pre> và lấy nội dung
        pre_content = soup.find('pre').text

        total = json.loads(pre_content)['data']['total']
        page_count = math.ceil(total/200)
        print(page_count)
    except Exception as e:
        page_count = 0

    if page_count > 0:
        for i in range(1,page_count + 1):
            driver.get(f"https://wms.ssc.shopee.vn/api/v2/apps/process/outbound/mtoorder/search_move_transfer_order?status=20&is_create_time_asc=0&pageno={str(i)}&count=200")
            time.sleep(0.5)
            page_content = driver.page_source
            soup = BeautifulSoup(page_content, 'html.parser')

            # Tìm thẻ <pre> và lấy nội dung
            pre_content = soup.find('pre').text

            parse_data = json.loads(pre_content)['data']['list']
            df_approved = pd.DataFrame(parse_data)[['mto_order_no','to_whs_id']]
            df_to_whs_list.append(df_approved)
    else:
        df_approved = pd.DataFrame()

    df_to_whs = pd.concat(df_to_whs_list)
    
    df_mt_final = pd.merge(df_mt_final, df_to_whs, on="mto_order_no", how="left")

    return df_mt_final
    # now = str(datetime.now().replace(microsecond=0))
    # print(df_mt_final)

    # df_mt_final['Update Time'] = now

    # gc = gspread.service_account(filename='surplus.json')
    # sh = gc.open_by_key('1YP-gkiOR0BCCqqkId8x8jVaUIASq3VagX2fEtWFWYHI')
    # ws = sh.worksheet("vnnc_data")

    # ws.clear()
    # ws.update(df_mt_final.values.tolist())

    # print("Update IB Shift Planning Preprocess Done")

wh_list = ["VNSC","VNNC"]

df_final_list = []
for wh in wh_list:
    df = mtp_picking(wh)
    df_final_list.append(df)

df_final = pd.concat(df_final_list)
now = str(datetime.now().replace(microsecond=0))

df_final['Update Time'] = now

gc = gspread.service_account(filename='surplus.json')
sh = gc.open_by_key('1YP-gkiOR0BCCqqkId8x8jVaUIASq3VagX2fEtWFWYHI')
ws = sh.worksheet("vnnc_data")

ws.clear()
ws.update(df_final.values.tolist())

print("Update MTO Picking Done")
