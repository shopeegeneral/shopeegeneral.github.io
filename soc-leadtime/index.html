<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SOC Leadtime Dashboard</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Data file generated by Python script -->
  <script src="data.js"></script>
  <style>
    body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; background: #f4f6f9; }
    .container { max-width: 1200px; margin: 2rem auto; padding: 1rem; }
    h1 { text-align: center; color: #2c3e50; margin-bottom: 1rem; }
    .filters, .tabs { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-bottom: 1.5rem; }
    input, select { padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; background: #fff; font-size: 0.9rem; }
    .cards, .detail-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .card { background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
    .card h3 { margin: 0; font-size: 1rem; color: #555; }
    .card p { font-size: 1.2rem; margin: 0.5rem 0 0; color: #333; }
    .overview-section, .detail-section, .chart-container { background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 2rem; }
    .table-wrapper { max-height: 400px; overflow-y: auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    th { background: #f0f0f0; position: sticky; top: 0; z-index: 1; }
    .tabs button { padding: 0.5rem 1rem; border: none; border-bottom: 2px solid transparent; background: transparent; cursor: pointer; font-size: 0.9rem; }
    .tabs button.active { border-color: #2c3e50; color: #2c3e50; }
  </style>
</head>
<body>
  <div class="container">
    <h1>SOC Leadtime Dashboard</h1>
    <!-- Filters: Preset Range or Custom -->
    <div class="filters">
      <select id="presetRange">
        <option value="" disabled>Select Range</option>
        <option value="1">Yesterday</option>
        <option value="7" selected>Last 7 Days</option>
        <option value="14">Last 14 Days</option>
        <option value="30">Last 1 Month</option>
        <option value="60">Last 2 Months</option>
        <option value="90">Last 3 Months</option>
        <option value="custom">Custom Range</option>
      </select>
      <input type="date" id="dateFrom" style="display:none;" />
      <input type="date" id="dateTo" style="display:none;" />
      <select id="filterStation"></select>
      <select id="filterCategory"></select>
    </div>
    <!-- KPI Cards -->
    <div class="cards" id="kpi-cards"></div>
    <!-- Performance Overview -->
    <div class="overview-section">
      <h2>Performance Overview</h2>
      <div class="cards" id="overview-cards"></div>
    </div>
    <!-- Detail Tabs -->
    <div class="tabs" id="task-tabs"></div>
    <div class="detail-section">
      <h2 id="detail-title">Detail Leadtime</h2>
      <div class="detail-cards" id="detail-cards"></div>
    </div>
    <!-- Chart -->
    <div class="chart-container">
      <canvas id="leadtimeChart"></canvas>
    </div>
    <!-- Table -->
    <div class="table-wrapper">
      <table id="data-table">
        <thead>
          <tr><th>Date</th><th>Station</th><th>Category</th><th>Task</th><th>Level</th><th>Hours</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <script>
    const rawData = Array.isArray(dataArray) ? dataArray : [];
    let filteredData = [];
    const levels = ['50p','80p','95p','99p','avg'];
    const tasksOrder = ['checkout_to_arrived','arrived_to_lhpacked','arrived_to_unloaded','unloaded_to_received','received_to_packed','packed_to_lhpacked','lhpacked_to_delivered','e2e leadtime'];

    // DOM refs
    const preset    = document.getElementById('presetRange');
    const dateFrom  = document.getElementById('dateFrom');
    const dateTo    = document.getElementById('dateTo');
    const selStation = document.getElementById('filterStation');
    const selCategory= document.getElementById('filterCategory');
    const kpiDiv     = document.getElementById('kpi-cards');
    const overviewDiv= document.getElementById('overview-cards');
    const tabsDiv    = document.getElementById('task-tabs');
    const detailTitle= document.getElementById('detail-title');
    const detailDiv  = document.getElementById('detail-cards');
    const tableBody  = document.querySelector('#data-table tbody');
    const ctx        = document.getElementById('leadtimeChart').getContext('2d');
    let chart;

    // Utility
    function unique(arr) { return [...new Set(arr)]; }
    function uniqueSorted(arr) { return unique(arr).sort(); }
    function fillSelect(el, opts, label) {
      el.innerHTML = `<option value="">All ${label}</option>` + opts.map(o => `<option value="${o}">${o}</option>`).join('');
    }

    // Initialize filters
    function initFilters() {
      fillSelect(selStation, uniqueSorted(rawData.map(d => d.station_name)), 'Stations');
      fillSelect(selCategory, uniqueSorted(rawData.map(d => d.order_category)), 'Categories');
    }

    // Apply date & station/category filters
    function applyFilters() {
      let from = null, to = null;
      if (preset.value && preset.value !== 'custom') {
        to = new Date();
        from = new Date();
        from.setDate(to.getDate() - parseInt(preset.value));
      } else if (preset.value === 'custom') {
        from = dateFrom.value ? new Date(dateFrom.value) : null;
        to   = dateTo.value   ? new Date(dateTo.value)   : null;
      }
      filteredData = rawData.filter(d => {
        const dt = new Date(d.created);
        if (from && dt < from) return false;
        if (to && dt > to) return false;
        if (selStation.value && d.station_name !== selStation.value) return false;
        if (selCategory.value && d.order_category !== selCategory.value) return false;
        return true;
      });
      renderAll();
    }

    // Render all components
    function renderAll() {
      renderKPIs();
      renderOverview();
      renderTabs();
      renderChart();
      renderTable();
    }

    // KPI cards
    function renderKPIs() {
      kpiDiv.innerHTML = '';
      levels.forEach(lvl => {
        const vals = filteredData.filter(d => d.lvl === lvl).map(d => +d.hrs);
        const avg = vals.length ? (vals.reduce((a,b) => a+b) / vals.length).toFixed(2) : 'N/A';
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<h3>${lvl}</h3><p>${avg}</p>`;
        kpiDiv.appendChild(card);
      });
    }

    // Compute best station
    function bestStation(tasks) {
      const bySt = {};
      filteredData.filter(d => tasks.includes(d.task) && d.lvl === 'avg')
        .forEach(d => {
          bySt[d.station_name] = (bySt[d.station_name] || 0) + +d.hrs;
        });
      let best = null, bestVal = Infinity;
      Object.entries(bySt).forEach(([st, sum]) => {
        if (sum < bestVal) { bestVal = sum; best = st; }
      });
      return { station: best || 'N/A', hrs: bestVal !== Infinity ? bestVal.toFixed(2) : 'N/A' };
    }

    // Performance overview
    function renderOverview() {
      overviewDiv.innerHTML = '';
      const metrics = [
        { label: 'Before Arrived SOC', tasks: ['checkout_to_arrived'] },
        { label: 'During SOC', tasks: ['arrived_to_lhpacked'] },
        { label: 'After Outbound SOC', tasks: ['lhpacked_to_delivered'] },
        // { label: 'Total Avg LT SOC', tasks: ['checkout_to_arrived','arrived_to_lhpacked','lhpacked_to_delivered'] }
      ];
      metrics.forEach(m => {
        const res = bestStation(m.tasks);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<h3>${m.label}</h3><p>${res.station} (${res.hrs}h)</p>`;
        overviewDiv.appendChild(card);
      });
    }

    // Detail tabs
    function renderTabs() {
      tabsDiv.innerHTML = '';
      tasksOrder.forEach((task, idx) => {
        const btn = document.createElement('button');
        btn.textContent = task;
        if (idx === 0) btn.classList.add('active');
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active'); renderDetail(task);
        });
        tabsDiv.appendChild(btn);
      });
      renderDetail(tasksOrder[0]);
    }

    // Detail section
    function renderDetail(task) {
      detailTitle.textContent = `Detail Leadtime: ${task}`;
      detailDiv.innerHTML = '';
      levels.forEach(lvl => {
        let vals;
        if (task === 'e2e leadtime') {
          vals = uniqueSorted(filteredData.map(d => d.created)).map(date =>
            filteredData.filter(d => d.created === date && d.lvl === lvl)
              .reduce((s,d) => s + +d.hrs, 0)
          );
        } else {
          vals = filteredData.filter(d => d.task === task && d.lvl === lvl).map(d => +d.hrs);
        }
        const avg = vals.length ? (vals.reduce((a,b) => a+b) / vals.length).toFixed(2) : 'N/A';
        const card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `<h3>${lvl}</h3><p>${avg}</p>`;
        detailDiv.appendChild(card);
      });
    }

    // Chart
    function renderChart() {
      const labels = uniqueSorted(filteredData.map(d => d.created));
      const dataAvg = labels.map(date => {
        const rec = filteredData.find(d => d.created === date && d.lvl === 'avg');
        return rec ? +rec.hrs : null;
      });
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Avg Leadtime', data: dataAvg, tension: 0.3, fill: false }] },
        options: { responsive: true }
      });
    }

    // Table
    function renderTable() {
      tableBody.innerHTML = '';
      filteredData.forEach(d => {
        const tr = document.createElement('tr');
        ['created','station_name','order_category','task','lvl','hrs'].forEach(k => {
          const td = document.createElement('td'); td.textContent = d[k]; tr.appendChild(td);
        });
        tableBody.appendChild(tr);
      });
    }

    // Show/hide date inputs
    preset.addEventListener('change', () => {
      if (preset.value === 'custom') {
        dateFrom.style.display = 'inline-block';
        dateTo.style.display = 'inline-block';
      } else {
        dateFrom.style.display = 'none';
        dateTo.style.display = 'none';
      }
      applyFilters();
    });

    // Init listeners
    [dateFrom,dateTo,selStation,selCategory].forEach(el => el.addEventListener('change', applyFilters));
    initFilters();
    applyFilters();
  </script>
</body>
</html>
