<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WH Tools</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.16.0/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p style="color: white;">ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>
    
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <img src="materials/shopee_logo_en_email.png" alt="Logo">
        </div>
        

        <select id="selectWarehouse">
            <option value="VNS">VNS</option>
            <option value="VNSC">VNSC</option>
        </select>

        <a href="#" onclick="showFrame('home')"><i class="fa-solid fa-home"></i> <span>Trang ch·ªß</span></a>
        <a href="#" onclick="showFrame('searchOrder')"><i class="fa-solid fa-magnifying-glass"></i> <span>Search Order</span></a>
        <a href="#" onclick="showFrame('vnsSkuMap')"><i class="fa-solid fa-map-location-dot"></i></i> <span>VNS - SKU MAP</span></a>
        <!-- <a href="#" onclick="showFrame('help')"><i class="fa fa-question-circle"></i> <span>Tr·ª£ gi√∫p</span></a> -->
        
        <div class="toggle-btn" onclick="toggleSidebar()">
            <i class="fa fa-bars"></i>
        </div>
    </div>

    <div class="content" id="content">
        <div id="home" class="frame active">
            <h1>Trang t·ªïng h·ª£p tool</h1>
            <p>Tool ƒë∆∞·ª£c build b·ªüi hau.giang@shopee.com</p>
            <div class="welcome">
                <img src="materials/welcome.png" alt="Logo">
            </div>
        </div>
        <div id="searchOrder" class="frame">
            <h1>T√¨m ki·∫øm ƒë∆°n h√†ng b·∫±ng SKUs</h1>
            <div class="search-filter-container">
                <input style="width: 200px;" type="text" id="searchInput" placeholder="Nh·∫≠p SKU / UPC" onkeypress="addToTable(event)">
            
                <div id="statusFilter">
                    <label><input type="checkbox" class="status-checkbox" value="All" checked> All</label>
                    <label><input type="checkbox" class="status-checkbox" value="Picked"> Picked</label>
                    <label><input type="checkbox" class="status-checkbox" value="Checking"> Checking</label>
                    <label><input type="checkbox" class="status-checkbox" value="Checked"> Checked</label>
                    <label><input type="checkbox" class="status-checkbox" value="Packing"> Packing</label>
                    <label><input type="checkbox" class="status-checkbox" value="Packed"> Packed</label>
                </div>

                <!-- <div class="dropdown">
                    <button class="dropdown-btn">Select Status ‚ñº</button>
                    <div class="dropdown-content">
                        <label><input type="checkbox" class="status-checkbox" value="All" checked> All</label>
                        <label><input type="checkbox" class="status-checkbox" value="Picked"> Picked</label>
                        <label><input type="checkbox" class="status-checkbox" value="Checking"> Checking</label>
                        <label><input type="checkbox" class="status-checkbox" value="Checked"> Checked</label>
                        <label><input type="checkbox" class="status-checkbox" value="Packing"> Packing</label>
                        <label><input type="checkbox" class="status-checkbox" value="Packed"> Packed</label>
                    </div>
                </div>
                <p>Selected Status: <span id="selectedStatus">All</span></p> -->

                
            </div>
            
            <button id="clearSkuTable">Clear Data</button> <!-- N√∫t X√≥a -->
            <!-- N√∫t m·ªü modal -->
            <button id="showCompleteOrders">Xem c√°c ƒë∆°n h√†ng ƒë·ªß</button>

            <label style="margin-left: 50px;" for="groupBy">Nh√≥m theo</label>
            <select id="groupBy" onchange="updateOrderTable()">
                <option value="Order">Order</option>
                <option value="PickingID">Picking ID</option>
            </select>

            
            

            <div class="search-container">
                <!-- Frame b√™n tr√°i -->
                <div class="left-frame">
                    <div class="scroll-modal2">
                        <table class="order-table" id="skuTable">
                            <thead>
                                <tr>
                                    <th>SKU / UPC</th>
                                    <th>SKU ID</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                            </tbody>
                        </table>
                    </div>
                </div>
        
                <!-- Frame b√™n ph·∫£i -->
                <div class="right-frame">
                    <div class="scroll-modal2">
                        <table class="order-table" id="orderTable">
                            <thead>
                                <tr>
                                    <th>SKU ID</th>
                                    <th>SL c·ªßa ƒë∆°n h√†ng</th>
                                    <th>SL TBS hi·ªán c√≥</th>
                                    <th>Backlog Time</th>
                                    <th>M√£ ƒë∆°n h√†ng / PickingID</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªông -->
                            </tbody>
                        </table>
                    </div>
                    
                </div>
            </div>

            <!-- Modal -->
            <div id="completeOrdersModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Danh s√°ch ƒë∆°n h√†ng ƒë·ªß s·ªë l∆∞·ª£ng</h2>
                    <div class="scroll-modal">
                        <table id="completeOrdersTable">
                            <thead>
                                <tr>
                                    <th>Order</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m ƒë·ªông -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


        
        
        <div id="vnsSkuMap" class="frame">
            <!-- <h1>T√¨m Zone</h1> -->
            
            <input type="text" id="searchSku" placeholder="Nh·∫≠p SKU / UPC">

            <p id="errorMessage"></p>


            <div class="form-group" id="zoneInfo">
                <label>Zone: </label>
                <label id="zoneId" style="font-size: 60px; font-weight: bold;">-</label>
            </div>
            <div class="form-group">
                <!-- <label>SKU ID: </label> -->
                <label id="skuId">-</label>
            </div>
            <div class="form-group">
                <!-- <label>SKU Name: </label> -->
                <label id="skuName">-</label>
            </div>
            <div class="form-group">
                <!-- <label>Shop Name: </label> -->
                <label id="shopName">-</label>
            </div>
        </div>
        
        <div id="help" class="frame">
            <h1>Tr·ª£ gi√∫p</h1>
            <p>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng h·ªá th·ªëng.</p>
        </div>
    </div>

    <script>
        let tbs_data = [];
        let original_data = [];
        let whs_selected = document.getElementById("selectWarehouse").value;

        async function load_data() {
            return fetch('https://script.google.com/macros/s/AKfycbwL7j8cnnoqtEj43JxtC07BgzS0nNI41ULxCR1XLoqN56gjWrO46w40s99L9jxvYS1t/exec')
                .then(res => res.json())
                .then(data => {
                    tbs_data = data.content;
                    original_data = data.content;
                    tbs_data = tbs_data.filter(row => row[0] === whs_selected)
                    console.log("Load d·ªØ li·ªáu th√†nh c√¥ng:", tbs_data);
                    
                });
        }

        document.getElementById("showCompleteOrders").addEventListener("click", function () {
            showCompleteOrdersModal();
        });

        document.querySelector(".close").addEventListener("click", function () {
            document.getElementById("completeOrdersModal").style.display = "none";
        });

        // ƒê√≥ng modal khi click ngo√†i
        window.onclick = function (event) {
            let modal = document.getElementById("completeOrdersModal");
            if (event.target === modal) {
                modal.style.display = "none";
            }
        };


        function showCompleteOrdersModal() {
            let completeOrdersTable = document.getElementById("completeOrdersTable").querySelector("tbody");
            completeOrdersTable.innerHTML = ""; // X√≥a d·ªØ li·ªáu c≈©

            let orderTable = document.getElementById("orderTable").querySelector("tbody");
            let completedOrders = new Set();

            // Duy·ªát qua orderTable ƒë·ªÉ l·∫•y c√°c ƒë∆°n h√†ng ƒë·ªß s·ªë l∆∞·ª£ng
            Array.from(orderTable.querySelectorAll("tr")).forEach(row => {
                let orderButton = row.querySelector(".order-button");
                if (orderButton && row.cells[3].style.backgroundColor === "lightgreen") {
                    completedOrders.add(orderButton.textContent);
                }
            });

            // Th√™m c√°c ƒë∆°n h√†ng v√†o b·∫£ng modal
            completedOrders.forEach(orderNo => {
                let newRow = completeOrdersTable.insertRow();
                let orderCell = newRow.insertCell(0);
                let actionCell = newRow.insertCell(1);

                orderCell.textContent = orderNo;

                let actionButton = document.createElement("button");
                actionButton.textContent = "In m√£ r·ªó";
                actionButton.classList.add("order-action-button");
                actionButton.onclick = () => getBasket(orderNo);

                actionCell.appendChild(actionButton);
            });

            document.getElementById("completeOrdersModal").style.display = "block";
        }



        document.getElementById("clearSkuTable").addEventListener("click", function () {
            let skuTable = document.getElementById("skuTable").querySelector("tbody");
            skuTable.innerHTML = ""; // X√≥a t·∫•t c·∫£ d√≤ng trong b·∫£ng
            
            console.log("skuTable ƒë√£ ƒë∆∞·ª£c x√≥a to√†n b·ªô d·ªØ li·ªáu.");

            updateOrderTable(); // C·∫≠p nh·∫≠t l·∫°i orderTable sau khi x√≥a d·ªØ li·ªáu
            resetScannedSkus()
        });


        // L·∫Øng nghe s·ª± ki·ªán change tr√™n checkbox
        document.querySelectorAll(".status-checkbox").forEach(checkbox => {
            checkbox.addEventListener("change", function () {
                handleStatusFilterChange();
            });
        });

        // H√†m x·ª≠ l√Ω khi thay ƒë·ªïi checkbox
        function handleStatusFilterChange() {
            let checkedStatuses = Array.from(document.querySelectorAll(".status-checkbox:checked"))
                                    .map(cb => cb.value);

            // N·∫øu ch·ªçn "All", b·ªè ch·ªçn t·∫•t c·∫£ tr·∫°ng th√°i kh√°c
            if (checkedStatuses.includes("All")) {
                document.querySelectorAll(".status-checkbox").forEach(cb => cb.checked = (cb.value === "All"));
                checkedStatuses = ["All"];
            } else {
                // B·ªè ch·ªçn "All" n·∫øu ch·ªçn tr·∫°ng th√°i kh√°c
                document.querySelector(".status-checkbox[value='All']").checked = false;
            }

            updateOrderTable(checkedStatuses);
        }
        
        let scannedSkus = new Set(); // Danh s√°ch SKU ƒë√£ qu√©t

        // function updateOrderTable(selectedStatuses = ["All"]) {
        //     let skuTable = document.getElementById("skuTable").querySelector("tbody");
        //     let orderTable = document.getElementById("orderTable").querySelector("tbody");

        //     orderTable.innerHTML = ""; // X√≥a n·ªôi dung c≈©

        //     let skuCounts = {}; 
        //     let skuAvailableSet = new Set();
            
        //     // **L·∫•y danh s√°ch SKU t·ª´ b·∫£ng `skuTable` (c·ªôt index 1)**
        //     let skuRows = Array.from(skuTable.querySelectorAll("tr"));
        //     if (skuRows.length === 0) {
        //         return; // N·∫øu kh√¥ng c√≥ SKU n√†o, kh√¥ng hi·ªÉn th·ªã g√¨
        //     }

        //     skuRows.forEach(row => {
        //         let skuID = row.cells[1].textContent.trim();
        //         skuCounts[skuID] = (skuCounts[skuID] || 0) + 1;
        //         skuAvailableSet.add(skuID);
        //     });

        //     let orderSummary = {}; 
        //     let validOrders = new Set();
        //     let orderSkuMap = {}; 

        //     tbs_data.forEach(row => {
        //         let orderNo = row[10];  
        //         let skuID = row[2];    
        //         let status = row[5];  

        //         if (!selectedStatuses.includes("All") && !selectedStatuses.includes(status)) {
        //             return;
        //         }

        //         if (!orderSkuMap[orderNo]) {
        //             orderSkuMap[orderNo] = new Set();
        //         }
        //         orderSkuMap[orderNo].add(skuID);
        //     });

        //     // **L·ªçc ƒë∆°n h√†ng c√≥ t·∫•t c·∫£ SKU n·∫±m trong `skuTable`**
        //     Object.entries(orderSkuMap).forEach(([orderNo, skuSet]) => {
        //         if ([...skuAvailableSet].every(sku => skuSet.has(sku))) {
        //             validOrders.add(orderNo);
        //         }
        //     });

        //     tbs_data.forEach(row => {
        //         let orderNo = row[10];  
        //         let skuID = row[2];    
        //         let requiredQty = parseInt(row[3]) || 0; 
        //         let status = row[5];   

        //         if (validOrders.has(orderNo)) {
        //             if (!orderSummary[orderNo]) {
        //                 orderSummary[orderNo] = { skus: [], allMatched: true, rowCount: 0 };
        //             }

        //             let currentQty = skuCounts[skuID] || 0; 

        //             if (currentQty < requiredQty) {
        //                 orderSummary[orderNo].allMatched = false;
        //             }

        //             orderSummary[orderNo].skus.push({
        //                 skuID: skuID,
        //                 requiredQty: requiredQty,
        //                 currentQty: currentQty,
        //                 status: status
        //             });

        //             orderSummary[orderNo].rowCount += 1;
        //         }
        //     });

        //     // **Hi·ªÉn th·ªã danh s√°ch ƒë∆°n h√†ng**
        //     Object.entries(orderSummary).forEach(([orderNo, details]) => {
        //         let orderMatched = details.allMatched; 
        //         let orderGroupClass = `order-group-${orderNo}`; 

        //         details.skus.forEach((skuInfo, index) => {
        //             let newRow = orderTable.insertRow();
        //             newRow.classList.add(orderGroupClass);

        //             let skuCell = newRow.insertCell(0);
        //             skuCell.textContent = skuInfo.skuID;

        //             let qtyCell = newRow.insertCell(1);
        //             qtyCell.textContent = skuInfo.requiredQty;

        //             let currentQtyCell = newRow.insertCell(2);
        //             currentQtyCell.textContent = skuInfo.currentQty;

        //             if (skuInfo.currentQty >= skuInfo.requiredQty) {
        //                 skuCell.style.backgroundColor = "lightgreen";
        //             }

        //             if (index === 0) {
        //                 let orderCell = newRow.insertCell(3);
        //                 let orderButton = document.createElement("button");
        //                 orderButton.textContent = orderNo;
        //                 orderButton.classList.add("order-button");
        //                 orderButton.onclick = () => getBasket(orderNo);

        //                 orderCell.appendChild(orderButton);
        //                 orderCell.rowSpan = details.rowCount;

        //                 if (orderMatched) {
        //                     orderCell.style.backgroundColor = "lightgreen";
        //                 }
        //             }
        //         });
        //     });
        // }
        




        // **H√†m x·ª≠ l√Ω khi ng∆∞·ªùi d√πng scan SKU**
        function scanSku(sku) {
            scannedSkus.add(sku); // Th√™m SKU v√†o danh s√°ch ƒë√£ qu√©t
            updateOrderTable(); // C·∫≠p nh·∫≠t b·∫£ng
        }

        // **H√†m reset danh s√°ch SKU ƒë√£ qu√©t**
        function resetScannedSkus() {
            scannedSkus.clear();
            updateOrderTable();
        }
        
        function updateOrderTable(selectedStatuses = ["All"]) {
            let groupBy = document.getElementById("groupBy").value;
            let groupIndex = groupBy === "Order" ? 1 : 10; // Order: row[1], Picking ID: row[10]
            
            let skuTable = document.getElementById("skuTable").querySelector("tbody");
            let orderTable = document.getElementById("orderTable").querySelector("tbody");
            orderTable.innerHTML = ""; // X√≥a n·ªôi dung c≈©
            
            // N·∫øu skuTable kh√¥ng c√≥ SKU n√†o, x√≥a lu√¥n orderTable
            if (skuTable.rows.length === 0) {
                return;
            }
            
            let skuCounts = {};
            let skuAvailableSet = new Set();
            
            Array.from(skuTable.querySelectorAll("tr")).forEach(row => {
                let skuID = row.cells[1].textContent.trim();
                skuCounts[skuID] = (skuCounts[skuID] || 0) + 1;
                skuAvailableSet.add(skuID);
            });
            
            let orderSummary = {};
            let validOrders = new Set();
            let orderSkuMap = {};
            
            tbs_data.forEach(row => {
                let orderKey = row[groupIndex]; // Group theo Order ho·∫∑c Picking ID
                let additionalData = row[9]; // D·ªØ li·ªáu t·ª´ c·ªôt 9
                let skuID = row[2];    
                let status = row[5];
                
                if (!selectedStatuses.includes("All") && !selectedStatuses.includes(status)) {
                    return;
                }
                
                if (!orderSkuMap[orderKey]) {
                    orderSkuMap[orderKey] = { skuSet: new Set(), additionalData: additionalData };
                }
                orderSkuMap[orderKey].skuSet.add(skuID);
            });
            
            Object.entries(orderSkuMap).forEach(([orderKey, data]) => {
                if ([...skuAvailableSet].every(sku => data.skuSet.has(sku))) {
                    validOrders.add(orderKey);
                }
            });
            
            tbs_data.forEach(row => {
                let orderKey = row[groupIndex];
                let additionalData = row[9]; // L·∫•y d·ªØ li·ªáu c·ªôt 9
                let skuID = row[2];
                let requiredQty = parseInt(row[3]) || 0;
                let status = row[5];
                
                if (validOrders.has(orderKey)) {
                    if (!orderSummary[orderKey]) {
                        orderSummary[orderKey] = { skus: [], allMatched: true, rowCount: 0, additionalData: additionalData };
                    }
                    
                    let currentQty = skuCounts[skuID] || 0;
                    
                    if (currentQty < requiredQty) {
                        orderSummary[orderKey].allMatched = false;
                    }
                    
                    orderSummary[orderKey].skus.push({
                        skuID: skuID,
                        requiredQty: requiredQty,
                        currentQty: currentQty,
                        status: status
                    });
                    
                    orderSummary[orderKey].rowCount += 1;
                }
            });
            
            Object.entries(orderSummary).forEach(([orderKey, details]) => {
                let orderMatched = details.allMatched;
                let firstRow = true;
                
                details.skus.forEach((skuInfo, index) => {
                    let newRow = orderTable.insertRow();
                    
                    let skuCell = newRow.insertCell(0);
                    skuCell.textContent = skuInfo.skuID;
                    
                    let qtyCell = newRow.insertCell(1);
                    qtyCell.textContent = skuInfo.requiredQty;
                    
                    let currentQtyCell = newRow.insertCell(2);
                    currentQtyCell.textContent = skuInfo.currentQty;
                    
                    if (skuInfo.currentQty >= skuInfo.requiredQty) {
                        skuCell.style.backgroundColor = "lightgreen";
                    }
                    
                    if (index === 0) {
                        let additionalCell = newRow.insertCell(3);
                        additionalCell.textContent = details.additionalData;
                        additionalCell.rowSpan = details.rowCount;
                        
                        let orderCell = newRow.insertCell(4);
                        let orderButton = document.createElement("button");
                        orderButton.textContent = orderKey;
                        orderButton.classList.add("order-button");
                        orderButton.onclick = () => getBasket(orderKey);
                        
                        orderCell.appendChild(orderButton);
                        orderCell.rowSpan = details.rowCount;
                        
                        if (orderMatched) {
                            orderCell.style.backgroundColor = "lightgreen";
                            additionalCell.style.backgroundColor = "lightgreen";
                        }
                    }
                });
            });
        }

        // function updateOrderTable(selectedStatuses = ["All"]) {
        //     let skuTable = document.getElementById("skuTable").querySelector("tbody");
        //     let orderTable = document.getElementById("orderTable").querySelector("tbody");

        //     orderTable.innerHTML = ""; // X√≥a n·ªôi dung c≈©

        //     let skuCounts = {}; 
        //     let skuAvailableSet = new Set();

        //     // L·∫•y danh s√°ch SKU t·ª´ `skuTable`
        //     Array.from(skuTable.querySelectorAll("tr")).forEach(row => {
        //         let skuID = row.cells[1].textContent.trim();
        //         skuCounts[skuID] = (skuCounts[skuID] || 0) + 1;
        //         skuAvailableSet.add(skuID);
        //     });

        //     let orderSummary = {}; 
        //     let validOrders = new Set();
        //     let orderSkuMap = {}; 
            
        //     tbs_data.forEach(row => {
        //         let orderNo = row[1];  
        //         let skuID = row[2];    
        //         let status = row[5];  

        //         if (!selectedStatuses.includes("All") && !selectedStatuses.includes(status)) {
        //             return;
        //         }

        //         if (!orderSkuMap[orderNo]) {
        //             orderSkuMap[orderNo] = new Set();
        //         }
        //         orderSkuMap[orderNo].add(skuID);
        //     });

        //     Object.entries(orderSkuMap).forEach(([orderNo, skuSet]) => {
        //         let allSkuExist = [...skuSet].every(sku => skuAvailableSet.has(sku));
        //         if (allSkuExist) {
        //             validOrders.add(orderNo);
        //         }
        //     });

        //     tbs_data.forEach(row => {
        //         let orderNo = row[1];  
        //         let skuID = row[2];    
        //         let requiredQty = parseInt(row[3]) || 0; 
        //         let status = row[5];   

        //         if (validOrders.has(orderNo)) {
        //             if (!orderSummary[orderNo]) {
        //                 orderSummary[orderNo] = { skus: [], allMatched: true, rowCount: 0 };
        //             }

        //             let currentQty = skuCounts[skuID] || 0; 

        //             if (currentQty < requiredQty) {
        //                 orderSummary[orderNo].allMatched = false;
        //             }

        //             orderSummary[orderNo].skus.push({
        //                 skuID: skuID,
        //                 requiredQty: requiredQty,
        //                 currentQty: currentQty,
        //                 status: status
        //             });

        //             orderSummary[orderNo].rowCount += 1; 
        //         }
        //     });

        //     console.log(orderSummary)

        //     Object.entries(orderSummary).forEach(([orderNo, details]) => {
        //         let orderMatched = details.allMatched; 
        //         let firstRow = true;
        //         let orderGroupClass = `order-group-${orderNo}`; 

        //         details.skus.forEach((skuInfo, index) => {
        //             let newRow = orderTable.insertRow();
        //             newRow.classList.add(orderGroupClass); // G√°n class theo orderNo

        //             let skuCell = newRow.insertCell(0);
        //             skuCell.textContent = skuInfo.skuID;

        //             let qtyCell = newRow.insertCell(1);
        //             qtyCell.textContent = skuInfo.requiredQty;

        //             let currentQtyCell = newRow.insertCell(2);
        //             currentQtyCell.textContent = skuInfo.currentQty;

        //             if (skuInfo.currentQty >= skuInfo.requiredQty) {
        //                 skuCell.style.backgroundColor = "lightgreen";
        //             }

        //             if (index === 0) {
        //                 let orderCell = newRow.insertCell(3);
        //                 let orderButton = document.createElement("button");
        //                 orderButton.textContent = orderNo;
        //                 orderButton.classList.add("order-button");
        //                 orderButton.onclick = () => getBasket(orderNo);

        //                 orderCell.appendChild(orderButton);
        //                 orderCell.rowSpan = details.rowCount;

        //                 if (orderMatched) {
        //                     orderCell.style.backgroundColor = "lightgreen";
        //                 }
        //             }
        //         });
        //     });
        // }


        // function updateOrderTable(selectedStatuses = ["All"]) {

        //     let skuTable = document.getElementById("skuTable").querySelector("tbody");
        //     let orderTable = document.getElementById("orderTable").querySelector("tbody");

        //     orderTable.innerHTML = ""; // X√≥a n·ªôi dung c≈©

        //     let skuCounts = {}; // L∆∞u s·ªë l∆∞·ª£ng SKU trong skuTable

        //     // L·∫•y danh s√°ch SKU ID t·ª´ skuTable
        //     Array.from(skuTable.querySelectorAll("tr")).forEach(row => {
        //         let skuID = row.cells[1].textContent; // SKU ID t·ª´ c·ªôt 2
        //         skuCounts[skuID] = (skuCounts[skuID] || 0) + 1; // ƒê·∫øm s·ªë l·∫ßn xu·∫•t hi·ªán
        //     });

        //     let orderSummary = {}; // L∆∞u tr·ªØ th√¥ng tin order

        //     // **B∆∞·ªõc 1: T√¨m t·∫•t c·∫£ ƒë∆°n h√†ng c√≥ SKU trong `skuTable` v√† l·ªçc theo tr·∫°ng th√°i**
        //     let matchedOrders = new Set();
        //     tbs_data.forEach(row => {
        //         let orderNo = row[1];  // C·ªôt 2: Order No
        //         let skuID = row[2];    // C·ªôt 3: SKU ID
        //         let status = row[5];   // C·ªôt 6: Status (Tr·∫°ng th√°i)

        //         // N·∫øu tr·∫°ng th√°i kh√¥ng n·∫±m trong danh s√°ch ƒë√£ ch·ªçn, b·ªè qua
        //         if (!selectedStatuses.includes("All") && !selectedStatuses.includes(status)) {
        //             return;
        //         }

        //         if (skuCounts[skuID]) {
        //             matchedOrders.add(orderNo); // L∆∞u l·∫°i order c√≥ SKU
        //         }
        //     });

        //     // **B∆∞·ªõc 2: L·∫•y to√†n b·ªô SKU c·ªßa c√°c ƒë∆°n h√†ng t√¨m ƒë∆∞·ª£c**
        //     tbs_data.forEach(row => {
        //         let orderNo = row[1];  // C·ªôt 2: Order No
        //         let skuID = row[2];    // C·ªôt 3: SKU ID
        //         let requiredQty = parseInt(row[3]) || 0; // C·ªôt 4: S·ªë l∆∞·ª£ng SKU c·∫ßn
        //         let status = row[5];   // C·ªôt 6: Status (Tr·∫°ng th√°i)

        //         // N·∫øu order n√†y c√≥ trong danh s√°ch ƒë√£ t√¨m ƒë∆∞·ª£c
        //         if (matchedOrders.has(orderNo)) {
        //             if (!orderSummary[orderNo]) {
        //                 orderSummary[orderNo] = { skus: [], allMatched: true, rowCount: 0 };
        //             }
        //             let currentQty = skuCounts[skuID] || 0; // S·ªë l∆∞·ª£ng hi·ªán c√≥

        //             // Ki·ªÉm tra n·∫øu s·ªë l∆∞·ª£ng kh√¥ng ƒë·ªß, ƒë√°nh d·∫•u order ch∆∞a ƒë·ªß
        //             if (currentQty < requiredQty) {
        //                 orderSummary[orderNo].allMatched = false;
        //             }

        //             orderSummary[orderNo].skus.push({
        //                 skuID: skuID,
        //                 requiredQty: requiredQty,
        //                 currentQty: currentQty,
        //                 status: status
        //             });

        //             orderSummary[orderNo].rowCount += 1; // ƒê·∫øm s·ªë h√†ng cho `rowSpan`
        //         }
        //     });

        //     // **B∆∞·ªõc 3: Hi·ªÉn th·ªã danh s√°ch ƒë∆°n h√†ng theo format y√™u c·∫ßu**
        //     Object.entries(orderSummary).forEach(([orderNo, details]) => {
        //         let orderMatched = details.allMatched; // Ki·ªÉm tra n·∫øu to√†n b·ªô SKU c·ªßa order ƒë·ªß
        //         let firstRow = true;

        //         details.skus.forEach((skuInfo, index) => {
        //             let newRow = orderTable.insertRow(); // Lu√¥n t·∫°o d√≤ng m·ªõi

        //             // T·∫°o √¥ cho SKU ID
        //             let skuCell = newRow.insertCell(0);
        //             skuCell.textContent = skuInfo.skuID;

        //             // T·∫°o √¥ cho SL c·ªßa ƒë∆°n h√†ng
        //             let qtyCell = newRow.insertCell(1);
        //             qtyCell.textContent = skuInfo.requiredQty;

        //             // T·∫°o √¥ cho SL TBS hi·ªán c√≥
        //             let currentQtyCell = newRow.insertCell(2);
        //             currentQtyCell.textContent = skuInfo.currentQty;

        //             // N·∫øu s·ªë l∆∞·ª£ng ƒë·ªß, highlight SKU
        //             if (skuInfo.currentQty >= skuInfo.requiredQty) {
        //                 skuCell.style.backgroundColor = "lightgreen";
        //             }

        //             // Ch·ªâ th√™m √¥ `M√£ ƒë∆°n h√†ng` v√†o d√≤ng ƒë·∫ßu ti√™n
        //             if (index === 0) {
        //                 let orderCell = newRow.insertCell(3);
        //                 let orderButton = document.createElement("button");
        //                 orderButton.textContent = orderNo;
        //                 orderButton.classList.add("order-button");
        //                 orderButton.onclick = () => console.log(`Order clicked: ${orderNo}`);

        //                 orderCell.appendChild(orderButton);
        //                 orderCell.rowSpan = details.rowCount; // G·ªôp √¥ theo s·ªë SKU

        //                 if (orderMatched) {
        //                     orderCell.style.backgroundColor = "lightgreen"; // Highlight n·∫øu ƒë·ªß SKU
        //                 }
        //             }
        //         });
        //     });
        // }


        function toggleSidebar() {
            document.getElementById("sidebar").classList.toggle("collapsed");
            document.getElementById("content").classList.toggle("collapsed");
        }

        let refreshInterval = null; // L∆∞u interval ID

        // H√†m thi·∫øt l·∫≠p interval khi v√†o frame `searchOrder`
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval); // ƒê·∫£m b·∫£o kh√¥ng b·ªã ch·∫°y nhi·ªÅu l·∫ßn
            }
            refreshInterval = setInterval(() => {
                console.log("üîÑ T·ª± ƒë·ªông l√†m m·ªõi d·ªØ li·ªáu ƒë∆°n h√†ng...");
                load_data().then(() => {
                    updateOrderTable(); // C·∫≠p nh·∫≠t l·∫°i b·∫£ng sau khi load
                });
            }, 30 * 60 * 1000); // 30 ph√∫t 30 * 60 * 1000
        }

        // H√†m h·ªßy interval khi r·ªùi frame `searchOrder`
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        

        function showFrame(frameId) {
            let frames = document.querySelectorAll('.frame');
            frames.forEach(frame => frame.classList.remove('active'));

            document.getElementById("loading").style.display = "block"; // Hi·ªÉn th·ªã loading

            document.getElementById(frameId).classList.add('active');
            console.log(`Frame ${frameId} is active.`);

            let loadDataPromise = Promise.resolve();

            if (frameId === "searchOrder") {
                loadDataPromise = load_data();
                startAutoRefresh(); // B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông l√†m m·ªõi m·ªói 30 ph√∫t
            } else {
                stopAutoRefresh(); // Ng·ª´ng l√†m m·ªõi n·∫øu kh√¥ng ·ªü frame `searchOrder`
            }

            if (frameId === "vnsSkuMap") {
                loadDataPromise = load_sku_map();
                // startAutoRefresh(); // B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông l√†m m·ªõi m·ªói 30 ph√∫t
            }

            loadDataPromise.then(() => {
                document.getElementById("loading").style.display = "none";
            });
        }



        function addToTable(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                let input = document.getElementById("searchInput");
                let skuValue = input.value.trim();

                if (skuValue === "") return;

                // T√¨m ki·∫øm trong tbs_data (c·ªôt 2, 6, 7, 8)
                let matchedRow = original_data.find(row => 
                    row[2].includes(skuValue) || 
                    row[6].includes(skuValue) || 
                    row[7].includes(skuValue) || 
                    row[8].includes(skuValue)
                );

                if (!matchedRow) {
                    alert("Kh√¥ng t√¨m th·∫•y SKU trong d·ªØ li·ªáu!");
                    input.value = "";
                    return;
                }

                let skuID = matchedRow[2]; // L·∫•y gi√° tr·ªã c·ªôt 2 (SKU ID)

                let table = document.getElementById("skuTable").querySelector("tbody");

                let newRow = table.insertRow();
                let skuCell = newRow.insertCell(0);
                let skuIDCell = newRow.insertCell(1);
                let actionCell = newRow.insertCell(2);

                skuCell.textContent = skuValue;
                skuIDCell.textContent = skuID;

                let deleteButton = document.createElement("button");
                deleteButton.textContent = "X√≥a";
                deleteButton.className = "delete-btn";
                deleteButton.onclick = function () {
                    table.removeChild(newRow);
                    updateOrderTable(); // C·∫≠p nh·∫≠t b·∫£ng ƒë∆°n h√†ng sau khi x√≥a SKU
                };

                actionCell.appendChild(deleteButton);

                input.value = "";
                updateOrderTable(); 
            }
        }


        // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi kho
        document.getElementById("selectWarehouse").addEventListener("change", function () {
            let selectedWarehouse = this.value;
            console.log(`Kho ƒë∆∞·ª£c ch·ªçn: ${selectedWarehouse}`);
            tbs_data = original_data.filter(row => row[0] === selectedWarehouse);

            // G·ªçi h√†m c·∫≠p nh·∫≠t b·∫£ng d·ª±a tr√™n kho ƒë∆∞·ª£c ch·ªçn
            updateOrderTable()
        });

        // H√†m l·ªçc d·ªØ li·ªáu theo kho
        function filterByWarehouse(warehouse) {
            let orderTable = document.getElementById("orderTable").querySelector("tbody");

            orderTable.innerHTML = ""; // X√≥a b·∫£ng tr∆∞·ªõc khi c·∫≠p nh·∫≠t

            let skuCounts = {}; // L∆∞u s·ªë l∆∞·ª£ng SKU trong b·∫£ng skuTable
            let skuTable = document.getElementById("skuTable").querySelector("tbody");

            // L·∫•y danh s√°ch SKU t·ª´ b·∫£ng skuTable
            Array.from(skuTable.querySelectorAll("tr")).forEach(row => {
                let skuID = row.cells[1].textContent;
                skuCounts[skuID] = (skuCounts[skuID] || 0) + 1;
            });

            let orderSummary = {}; // L∆∞u d·ªØ li·ªáu ƒë∆°n h√†ng theo kho

            // L·ªçc d·ªØ li·ªáu d·ª±a tr√™n kho ƒë∆∞·ª£c ch·ªçn
            original_data.forEach(row => {
                let warehouseID = row[0]; // C·ªôt 1: M√£ kho
                let orderNo = row[1];  // C·ªôt 2: Order No
                let skuID = row[2];    // C·ªôt 3: SKU ID
                let requiredQty = parseInt(row[3]) || 0; // C·ªôt 4: S·ªë l∆∞·ª£ng SKU

                // Ch·ªâ l·∫•y d·ªØ li·ªáu c·ªßa kho ƒë∆∞·ª£c ch·ªçn
                if (warehouseID === warehouse) {
                    if (!orderSummary[orderNo]) {
                        orderSummary[orderNo] = { skus: [], allMatched: true, rowCount: 0 };
                    }

                    let currentQty = skuCounts[skuID] || 0; // S·ªë l∆∞·ª£ng SKU hi·ªán c√≥

                    // Ki·ªÉm tra s·ªë l∆∞·ª£ng ƒë·ªß hay kh√¥ng
                    if (currentQty < requiredQty) {
                        orderSummary[orderNo].allMatched = false;
                    }

                    orderSummary[orderNo].skus.push({
                        skuID: skuID,
                        requiredQty: requiredQty,
                        currentQty: currentQty
                    });

                    orderSummary[orderNo].rowCount += 1;
                }
            });

            // C·∫≠p nh·∫≠t b·∫£ng orderTable v·ªõi d·ªØ li·ªáu l·ªçc theo kho
            Object.entries(orderSummary).forEach(([orderNo, details]) => {
                let firstRow = true;
                let orderMatched = details.allMatched;

                let orderGroup = document.createElement("tbody");
                orderGroup.classList.add("order-group");

                details.skus.forEach((skuInfo, index) => {
                    let newRow = orderGroup.insertRow();

                    let skuCell = newRow.insertCell(0);
                    skuCell.textContent = skuInfo.skuID;

                    let qtyCell = newRow.insertCell(1);
                    qtyCell.textContent = skuInfo.requiredQty;

                    let currentQtyCell = newRow.insertCell(2);
                    currentQtyCell.textContent = skuInfo.currentQty;

                    if (skuInfo.currentQty >= skuInfo.requiredQty) {
                        skuCell.style.backgroundColor = "lightgreen";
                    }

                    if (index === 0) {
                        let orderCell = newRow.insertCell(3);
                        let orderButton = document.createElement("button");
                        orderButton.textContent = orderNo;
                        orderButton.classList.add("order-button");
                        orderButton.onclick = () => getBasket(orderNo);

                        orderCell.appendChild(orderButton);
                        orderCell.rowSpan = details.rowCount;

                        if (orderMatched) {
                            orderCell.style.backgroundColor = "lightgreen";
                        }
                    }
                });

                orderTable.appendChild(orderGroup);
            });
        }

        async function downloadAll(order, bsk) {
            let pdfDoc = await PDFLib.PDFDocument.create();
            let pdfWidth = 288;
            let pdfHeight = 144;
            let canvas = document.createElement("canvas");
            canvas.width = 800;
            canvas.height = 400;
            let counter = 1; // B·∫Øt ƒë·∫ßu t·ª´ 1

            // üñ®Ô∏è **T·∫°o barcode cho Location**
            let barcodeImage = await generateBarcode(bsk);
            let barcodeImage2 = await generateBarcode(order);

            // üé® **Thi·∫øt K·∫ø Nh√£n Tr√™n Canvas**
            let ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);


            // üè∑Ô∏è **Th√¥ng tin SKU**
            ctx.fillStyle = "black";
            ctx.font = "bold 30px Arial";
            ctx.fillText("Troubleshoots", 30, 100);

            // 3Ô∏è‚É£ **V·∫Ω Barcode**
            let barcodeImg2 = new Image();
            await new Promise(resolve => {
                barcodeImg2.onload = resolve;
                barcodeImg2.src = barcodeImage2;
            });
            ctx.drawImage(barcodeImg2, 30, 100, 400, 120);

            // 3Ô∏è‚É£ **V·∫Ω Barcode**
            let barcodeImg = new Image();
            await new Promise(resolve => {
                barcodeImg.onload = resolve;
                barcodeImg.src = barcodeImage;
            });
            ctx.drawImage(barcodeImg, 30, 260, 400, 120);

            // 4Ô∏è‚É£ **Chuy·ªÉn Canvas Th√†nh ·∫¢nh V√† Nh√∫ng V√†o PDF**
            let imgBytes = canvas.toDataURL("image/png").split(",")[1];
            let imgBuffer = Uint8Array.from(atob(imgBytes), c => c.charCodeAt(0));
            let img = await pdfDoc.embedPng(imgBuffer);

            let page = pdfDoc.addPage([pdfWidth, pdfHeight]);
            page.drawImage(img, { x: 0, y: 0, width: pdfWidth, height: pdfHeight });

            let pdfBytes = await pdfDoc.save();
            let blob = new Blob([pdfBytes], { type: "application/pdf" });
            let blobUrl = URL.createObjectURL(blob);

            let link = document.createElement("a");
            link.href = blobUrl;
            link.download = "Labels.pdf";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        }

        function generateBarcode(text, fontSize = 30) {
            let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");

            JsBarcode(svg, text, {
                format: "CODE128",
                displayValue: true, // Hi·ªÉn th·ªã gi√° tr·ªã d∆∞·ªõi barcode
                fontSize: fontSize, // K√≠ch th∆∞·ªõc ch·ªØ c·ªßa value
                // fontOptions: "bold", // L√†m ƒë·∫≠m ch·ªØ
                width: 2, // ƒê·ªô r·ªông v·∫°ch barcode
                // height: barcodeHeight, // Chi·ªÅu cao c·ªßa barcode
                margin: 10 // Kho·∫£ng c√°ch l·ªÅ
            });

            let xml = new XMLSerializer().serializeToString(svg);
            let svg64 = btoa(xml);
            return "data:image/svg+xml;base64," + svg64;
        }

        function getBasket(order) {
            const foundBsk = original_data.find(row => row[1] === order);
            if (!foundBsk) {
                downloadAll(order, "---")
            }
            var bsk = foundBsk[4]
            if (bsk === "") {
                bsk = "-"
            }
            console.log(bsk)
            downloadAll(order, bsk)
        }

    // SKU MAP
    let sku_map_data = [];
    async function load_sku_map() {
        return fetch('https://script.google.com/macros/s/AKfycbwqrPLe5Po68CUpx8M-ct31eR5Tnuc3YOkSOBu71qiOsUenNLXs3skZBJK3bmh-ieF2qg/exec')
            .then(res => res.json())
            .then(data => {
                sku_map_data = data.content;
                console.log("Load d·ªØ li·ªáu SKU MAP th√†nh c√¥ng:", sku_map_data);
            });
    }

    document.addEventListener("DOMContentLoaded", function () {
        let searchSku = document.getElementById("searchSku");
        let isActive = false;

        // Khi frame vnsSkuMap active, l·∫Øng nghe s·ª± ki·ªán b√†n ph√≠m
        function activateFrame() {
            isActive = true;
            // document.addEventListener("keydown", handleKeyPress);
        }

        // Khi chuy·ªÉn sang frame kh√°c, t·∫Øt l·∫Øng nghe
        function deactivateFrame() {
            isActive = false;
            // document.removeEventListener("keydown", handleKeyPress);
            searchSku.value = ""; // X√≥a n·ªôi dung input khi r·ªùi frame
        }

        // L·∫Øng nghe s·ª± ki·ªán "input" thay v√¨ "keydown"
        searchSku.addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                handleEnterPress(searchSku.value.trim()); 
                searchSku.value = ""; 
            }
        });

        // H√†m th·ª±c thi khi nh·∫•n Enter
        function handleEnterPress(value) {
            if (value) {
                console.log("Ng∆∞·ªùi d√πng nh·∫≠p:", value);
                let matchedRow = sku_map_data.find(row => 
                    String(row[0]).includes(value) || 
                    String(row[5]).includes(value) || 
                    String(row[6]).includes(value) || 
                    String(row[7]).includes(value)
                );

                if (!matchedRow) {
                    let errorMessage = document.getElementById("errorMessage");
                    errorMessage.textContent = `‚ùå Kh√¥ng t√¨m th·∫•y SKU: ${value}`;
                    errorMessage.style.display = "block"; // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói

                    document.getElementById("zoneId").textContent = "";
                    document.getElementById("skuId").textContent = "";
                    document.getElementById("shopName").textContent = "";
                    document.getElementById("skuName").textContent = "";
                    document.getElementById("zoneInfo").style.backgroundColor = "";
                    return;
                }

                document.getElementById("errorMessage").style.display = "none";
                let skuID = matchedRow[0]; 
                let zoneID = matchedRow[3]; // Gi√° tr·ªã c√≥ th·ªÉ l√† A, C, D, SP
                let shopName = matchedRow[2];
                let skuName = matchedRow[4];

                document.getElementById("zoneId").textContent = zoneID;
                document.getElementById("skuId").textContent = skuID;
                document.getElementById("shopName").textContent = shopName;
                document.getElementById("skuName").textContent = skuName;
                document.getElementById("zoneInfo").style.backgroundColor = "lightgreen";

                // üîä Ph√°t √¢m thanh t∆∞∆°ng ·ª©ng
                let audioFile = `materials/zone/${zoneID}.mp3`;
                let audio = new Audio(audioFile);
                audio.play();
            }
        }


        // ‚úÖ C·∫≠p nh·∫≠t l·∫°i s·ª± ki·ªán click c·ªßa menu sau khi DOM load xong
        document.querySelectorAll("a[href^='#']").forEach(link => {
            link.addEventListener("click", function (event) {
                event.preventDefault();
                let frameId = this.getAttribute("onclick").match(/showFrame\('(.+?)'\)/)[1];
                showFrame2(frameId);
            });
        });
        // ‚úÖ Gi·ªØ nguy√™n h√†m `showFrame`
        function showFrame2(frameId) {
            let frames = document.querySelectorAll(".frame");
            frames.forEach(frame => frame.classList.remove("active"));
            document.getElementById(frameId).classList.add("active");

            if (frameId === "vnsSkuMap") {
                activateFrame();
            } else {
                deactivateFrame();
            }
        }

    });

    </script>
</body>
</html>
