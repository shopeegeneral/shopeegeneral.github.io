<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WH Tools</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.16.0/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p style="color: white;">Đang tải dữ liệu...</p>
    </div>
    
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <img src="materials/shopee_logo_en_email.png" alt="Logo">
        </div>
        

        <select id="selectWarehouse">
            <option value="VNS">VNS</option>
            <option value="VNSC">VNSC</option>
        </select>

        <a href="#" onclick="showFrame('home')"><i class="fa-solid fa-home"></i> <span>Trang chủ</span></a>
        <a href="#" onclick="showFrame('searchOrder')"><i class="fa-solid fa-magnifying-glass"></i> <span>Search Order</span></a>
        <a href="#" onclick="showFrame('vnsSkuMap')"><i class="fa-solid fa-map-location-dot"></i></i> <span>VNS - SKU MAP</span></a>
        <!-- <a href="#" onclick="showFrame('help')"><i class="fa fa-question-circle"></i> <span>Trợ giúp</span></a> -->
        
        <div class="toggle-btn" onclick="toggleSidebar()">
            <i class="fa fa-bars"></i>
        </div>
    </div>

    <div class="content" id="content">
        <div id="home" class="frame active">
            <h1>Trang tổng hợp tool</h1>
            <p>Tool được build bởi hau.giang@shopee.com</p>
            <div class="welcome">
                <img src="materials/welcome.png" alt="Logo">
            </div>
        </div>
        <div id="searchOrder" class="frame">
            <h1>Tìm kiếm đơn hàng bằng SKUs</h1>
            <div class="search-filter-container">
                <input style="width: 200px;" type="text" id="searchInput" placeholder="Nhập SKU / UPC" onkeypress="addToTable(event)">
            
                <div id="statusFilter">
                    <label><input type="checkbox" class="status-checkbox" value="All" checked> All</label>
                    <label><input type="checkbox" class="status-checkbox" value="Picked"> Picked</label>
                    <label><input type="checkbox" class="status-checkbox" value="Checking"> Checking</label>
                    <label><input type="checkbox" class="status-checkbox" value="Checked"> Checked</label>
                    <label><input type="checkbox" class="status-checkbox" value="Packing"> Packing</label>
                    <label><input type="checkbox" class="status-checkbox" value="Packed"> Packed</label>
                </div>

                <!-- <div class="dropdown">
                    <button class="dropdown-btn">Select Status ▼</button>
                    <div class="dropdown-content">
                        <label><input type="checkbox" class="status-checkbox" value="All" checked> All</label>
                        <label><input type="checkbox" class="status-checkbox" value="Picked"> Picked</label>
                        <label><input type="checkbox" class="status-checkbox" value="Checking"> Checking</label>
                        <label><input type="checkbox" class="status-checkbox" value="Checked"> Checked</label>
                        <label><input type="checkbox" class="status-checkbox" value="Packing"> Packing</label>
                        <label><input type="checkbox" class="status-checkbox" value="Packed"> Packed</label>
                    </div>
                </div>
                <p>Selected Status: <span id="selectedStatus">All</span></p> -->

                
            </div>
            
            <button id="clearSkuTable">Clear Data</button> <!-- Nút Xóa -->
            <!-- Nút mở modal -->
            <button id="showCompleteOrders">Xem các đơn hàng đủ</button>

            <label style="margin-left: 50px;" for="groupBy">Nhóm theo</label>
            <select id="groupBy" onchange="updateOrderTable()">
                <option value="Order">Order</option>
                <option value="PickingID">Picking ID</option>
            </select>

            
            

            <div class="search-container">
                <!-- Frame bên trái -->
                <div class="left-frame">
                    <div class="scroll-modal2">
                        <table class="order-table" id="skuTable">
                            <thead>
                                <tr>
                                    <th>SKU / UPC</th>
                                    <th>SKU ID</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dữ liệu sẽ được thêm vào đây -->
                            </tbody>
                        </table>
                    </div>
                </div>
        
                <!-- Frame bên phải -->
                <div class="right-frame">
                    <div class="scroll-modal2">
                        <table class="order-table" id="orderTable">
                            <thead>
                                <tr>
                                    <th>SKU ID</th>
                                    <th>SL của đơn hàng</th>
                                    <th>SL TBS hiện có</th>
                                    <th>Backlog Time</th>
                                    <th>Mã đơn hàng / PickingID</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dữ liệu sẽ được cập nhật động -->
                            </tbody>
                        </table>
                    </div>
                    
                </div>
            </div>

            <!-- Modal -->
            <div id="completeOrdersModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Danh sách đơn hàng đủ số lượng</h2>
                    <div class="scroll-modal">
                        <table id="completeOrdersTable">
                            <thead>
                                <tr>
                                    <th>Order</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dữ liệu sẽ được thêm động -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>


        
        
        <div id="vnsSkuMap" class="frame">
            <!-- <h1>Tìm Zone</h1> -->
            
            <input type="text" id="searchSku" placeholder="Nhập SKU / UPC">

            <p id="errorMessage"></p>


            <div class="form-group" id="zoneInfo">
                <label>Zone: </label>
                <label id="zoneId" style="font-size: 60px; font-weight: bold;">-</label>
            </div>
            <div class="form-group">
                <!-- <label>SKU ID: </label> -->
                <label id="skuId">-</label>
            </div>
            <div class="form-group">
                <!-- <label>SKU Name: </label> -->
                <label id="skuName">-</label>
            </div>
            <div class="form-group">
                <!-- <label>Shop Name: </label> -->
                <label id="shopName">-</label>
            </div>
        </div>
        
        <div id="help" class="frame">
            <h1>Trợ giúp</h1>
            <p>Hướng dẫn sử dụng hệ thống.</p>
        </div>
    </div>

    <script>
        let tbs_data = [];
        let original_data = [];
        let whs_selected = document.getElementById("selectWarehouse").value;

        async function load_data() {
            return fetch('https://script.google.com/macros/s/AKfycbwL7j8cnnoqtEj43JxtC07BgzS0nNI41ULxCR1XLoqN56gjWrO46w40s99L9jxvYS1t/exec')
                .then(res => res.json())
                .then(data => {
                    tbs_data = data.content;
                    original_data = data.content;
                    tbs_data = tbs_data.filter(row => row[0] === whs_selected)
                    console.log("Load dữ liệu thành công:", tbs_data);
                    
                });
        }

        document.getElementById("showCompleteOrders").addEventListener("click", function () {
            showCompleteOrdersModal();
        });

        document.querySelector(".close").addEventListener("click", function () {
            document.getElementById("completeOrdersModal").style.display = "none";
        });

        // Đóng modal khi click ngoài
        window.onclick = function (event) {
            let modal = document.getElementById("completeOrdersModal");
            if (event.target === modal) {
                modal.style.display = "none";
            }
        };


        function showCompleteOrdersModal() {
            let completeOrdersTable = document.getElementById("completeOrdersTable").querySelector("tbody");
            completeOrdersTable.innerHTML = ""; // Xóa dữ liệu cũ

            let orderTable = document.getElementById("orderTable").querySelector("tbody");
            let completedOrders = new Set();

            // Duyệt qua orderTable để lấy các đơn hàng đủ số lượng
            Array.from(orderTable.querySelectorAll("tr")).forEach(row => {
                let orderButton = row.querySelector(".order-button");
                if (orderButton && row.cells[3].style.backgroundColor === "lightgreen") {
                    completedOrders.add(orderButton.textContent);
                }
            });

            // Thêm các đơn hàng vào bảng modal
            completedOrders.forEach(orderNo => {
                let newRow = completeOrdersTable.insertRow();
                let orderCell = newRow.insertCell(0);
                let actionCell = newRow.insertCell(1);

                orderCell.textContent = orderNo;

                let actionButton = document.createElement("button");
                actionButton.textContent = "In mã rỗ";
                actionButton.classList.add("order-action-button");
                actionButton.onclick = () => getBasket(orderNo);

                actionCell.appendChild(actionButton);
            });

            document.getElementById("completeOrdersModal").style.display = "block";
        }



        document.getElementById("clearSkuTable").addEventListener("click", function () {
            let skuTable = document.getElementById("skuTable").querySelector("tbody");
            skuTable.innerHTML = ""; // Xóa tất cả dòng trong bảng
            
            console.log("skuTable đã được xóa toàn bộ dữ liệu.");

            updateOrderTable(); // Cập nhật lại orderTable sau khi xóa dữ liệu
            resetScannedSkus()
        });


        // Lắng nghe sự kiện change trên checkbox
        document.querySelectorAll(".status-checkbox").forEach(checkbox => {
            checkbox.addEventListener("change", function () {
                handleStatusFilterChange();
            });
        });

        // Hàm xử lý khi thay đổi checkbox
        function handleStatusFilterChange() {
            let checkedStatuses = Array.from(document.querySelectorAll(".status-checkbox:checked"))
                                    .map(cb => cb.value);

            // Nếu chọn "All", bỏ chọn tất cả trạng thái khác
            if (checkedStatuses.includes("All")) {
                document.querySelectorAll(".status-checkbox").forEach(cb => cb.checked = (cb.value === "All"));
                checkedStatuses = ["All"];
            } else {
                // Bỏ chọn "All" nếu chọn trạng thái khác
                document.querySelector(".status-checkbox[value='All']").checked = false;
            }

            updateOrderTable(checkedStatuses);
        }
        
        let scannedSkus = new Set(); // Danh sách SKU đã quét

        // function updateOrderTable(selectedStatuses = ["All"]) {
        //     let skuTable = document.getElementById("skuTable").querySelector("tbody");
        //     let orderTable = document.getElementById("orderTable").querySelector("tbody");

        //     orderTable.innerHTML = ""; // Xóa nội dung cũ

        //     let skuCounts = {}; 
        //     let skuAvailableSet = new Set();
            
        //     // **Lấy danh sách SKU từ bảng `skuTable` (cột index 1)**
        //     let skuRows = Array.from(skuTable.querySelectorAll("tr"));
        //     if (skuRows.length === 0) {
        //         return; // Nếu không có SKU nào, không hiển thị gì
        //     }

        //     skuRows.forEach(row => {
        //         let skuID = row.cells[1].textContent.trim();
        //         skuCounts[skuID] = (skuCounts[skuID] || 0) + 1;
        //         skuAvailableSet.add(skuID);
        //     });

        //     let orderSummary = {}; 
        //     let validOrders = new Set();
        //     let orderSkuMap = {}; 

        //     tbs_data.forEach(row => {
        //         let orderNo = row[10];  
        //         let skuID = row[2];    
        //         let status = row[5];  

        //         if (!selectedStatuses.includes("All") && !selectedStatuses.includes(status)) {
        //             return;
        //         }

        //         if (!orderSkuMap[orderNo]) {
        //             orderSkuMap[orderNo] = new Set();
        //         }
        //         orderSkuMap[orderNo].add(skuID);
        //     });

        //     // **Lọc đơn hàng có tất cả SKU nằm trong `skuTable`**
        //     Object.entries(orderSkuMap).forEach(([orderNo, skuSet]) => {
        //         if ([...skuAvailableSet].every(sku => skuSet.has(sku))) {
        //             validOrders.add(orderNo);
        //         }
        //     });

        //     tbs_data.forEach(row => {
        //         let orderNo = row[10];  
        //         let skuID = row[2];    
        //         let requiredQty = parseInt(row[3]) || 0; 
        //         let status = row[5];   

        //         if (validOrders.has(orderNo)) {
        //             if (!orderSummary[orderNo]) {
        //                 orderSummary[orderNo] = { skus: [], allMatched: true, rowCount: 0 };
        //             }

        //             let currentQty = skuCounts[skuID] || 0; 

        //             if (currentQty < requiredQty) {
        //                 orderSummary[orderNo].allMatched = false;
        //             }

        //             orderSummary[orderNo].skus.push({
        //                 skuID: skuID,
        //                 requiredQty: requiredQty,
        //                 currentQty: currentQty,
        //                 status: status
        //             });

        //             orderSummary[orderNo].rowCount += 1;
        //         }
        //     });

        //     // **Hiển thị danh sách đơn hàng**
        //     Object.entries(orderSummary).forEach(([orderNo, details]) => {
        //         let orderMatched = details.allMatched; 
        //         let orderGroupClass = `order-group-${orderNo}`; 

        //         details.skus.forEach((skuInfo, index) => {
        //             let newRow = orderTable.insertRow();
        //             newRow.classList.add(orderGroupClass);

        //             let skuCell = newRow.insertCell(0);
        //             skuCell.textContent = skuInfo.skuID;

        //             let qtyCell = newRow.insertCell(1);
        //             qtyCell.textContent = skuInfo.requiredQty;

        //             let currentQtyCell = newRow.insertCell(2);
        //             currentQtyCell.textContent = skuInfo.currentQty;

        //             if (skuInfo.currentQty >= skuInfo.requiredQty) {
        //                 skuCell.style.backgroundColor = "lightgreen";
        //             }

        //             if (index === 0) {
        //                 let orderCell = newRow.insertCell(3);
        //                 let orderButton = document.createElement("button");
        //                 orderButton.textContent = orderNo;
        //                 orderButton.classList.add("order-button");
        //                 orderButton.onclick = () => getBasket(orderNo);

        //                 orderCell.appendChild(orderButton);
        //                 orderCell.rowSpan = details.rowCount;

        //                 if (orderMatched) {
        //                     orderCell.style.backgroundColor = "lightgreen";
        //                 }
        //             }
        //         });
        //     });
        // }
        




        // **Hàm xử lý khi người dùng scan SKU**
        function scanSku(sku) {
            scannedSkus.add(sku); // Thêm SKU vào danh sách đã quét
            updateOrderTable(); // Cập nhật bảng
        }

        // **Hàm reset danh sách SKU đã quét**
        function resetScannedSkus() {
            scannedSkus.clear();
            updateOrderTable();
        }
        
        function updateOrderTable(selectedStatuses = ["All"]) {
            let groupBy = document.getElementById("groupBy").value;
            let groupIndex = groupBy === "Order" ? 1 : 10; // Order: row[1], Picking ID: row[10]
            
            let skuTable = document.getElementById("skuTable").querySelector("tbody");
            let orderTable = document.getElementById("orderTable").querySelector("tbody");
            orderTable.innerHTML = ""; // Xóa nội dung cũ
            
            // Nếu skuTable không có SKU nào, xóa luôn orderTable
            if (skuTable.rows.length === 0) {
                return;
            }
            
            let skuCounts = {};
            let skuAvailableSet = new Set();
            
            Array.from(skuTable.querySelectorAll("tr")).forEach(row => {
                let skuID = row.cells[1].textContent.trim();
                skuCounts[skuID] = (skuCounts[skuID] || 0) + 1;
                skuAvailableSet.add(skuID);
            });
            
            let orderSummary = {};
            let validOrders = new Set();
            let orderSkuMap = {};
            
            tbs_data.forEach(row => {
                let orderKey = row[groupIndex]; // Group theo Order hoặc Picking ID
                let additionalData = row[9]; // Dữ liệu từ cột 9
                let skuID = row[2];    
                let status = row[5];
                
                if (!selectedStatuses.includes("All") && !selectedStatuses.includes(status)) {
                    return;
                }
                
                if (!orderSkuMap[orderKey]) {
                    orderSkuMap[orderKey] = { skuSet: new Set(), additionalData: additionalData };
                }
                orderSkuMap[orderKey].skuSet.add(skuID);
            });
            
            Object.entries(orderSkuMap).forEach(([orderKey, data]) => {
                if ([...skuAvailableSet].every(sku => data.skuSet.has(sku))) {
                    validOrders.add(orderKey);
                }
            });
            
            tbs_data.forEach(row => {
                let orderKey = row[groupIndex];
                let additionalData = row[9]; // Lấy dữ liệu cột 9
                let skuID = row[2];
                let requiredQty = parseInt(row[3]) || 0;
                let status = row[5];
                
                if (validOrders.has(orderKey)) {
                    if (!orderSummary[orderKey]) {
                        orderSummary[orderKey] = { skus: [], allMatched: true, rowCount: 0, additionalData: additionalData };
                    }
                    
                    let currentQty = skuCounts[skuID] || 0;
                    
                    if (currentQty < requiredQty) {
                        orderSummary[orderKey].allMatched = false;
                    }
                    
                    orderSummary[orderKey].skus.push({
                        skuID: skuID,
                        requiredQty: requiredQty,
                        currentQty: currentQty,
                        status: status
                    });
                    
                    orderSummary[orderKey].rowCount += 1;
                }
            });
            
            Object.entries(orderSummary).forEach(([orderKey, details]) => {
                let orderMatched = details.allMatched;
                let firstRow = true;
                
                details.skus.forEach((skuInfo, index) => {
                    let newRow = orderTable.insertRow();
                    
                    let skuCell = newRow.insertCell(0);
                    skuCell.textContent = skuInfo.skuID;
                    
                    let qtyCell = newRow.insertCell(1);
                    qtyCell.textContent = skuInfo.requiredQty;
                    
                    let currentQtyCell = newRow.insertCell(2);
                    currentQtyCell.textContent = skuInfo.currentQty;
                    
                    if (skuInfo.currentQty >= skuInfo.requiredQty) {
                        skuCell.style.backgroundColor = "lightgreen";
                    }
                    
                    if (index === 0) {
                        let additionalCell = newRow.insertCell(3);
                        additionalCell.textContent = details.additionalData;
                        additionalCell.rowSpan = details.rowCount;
                        
                        let orderCell = newRow.insertCell(4);
                        let orderButton = document.createElement("button");
                        orderButton.textContent = orderKey;
                        orderButton.classList.add("order-button");
                        orderButton.onclick = () => getBasket(orderKey);
                        
                        orderCell.appendChild(orderButton);
                        orderCell.rowSpan = details.rowCount;
                        
                        if (orderMatched) {
                            orderCell.style.backgroundColor = "lightgreen";
                            additionalCell.style.backgroundColor = "lightgreen";
                        }
                    }
                });
            });
        }

        // function updateOrderTable(selectedStatuses = ["All"]) {
        //     let skuTable = document.getElementById("skuTable").querySelector("tbody");
        //     let orderTable = document.getElementById("orderTable").querySelector("tbody");

        //     orderTable.innerHTML = ""; // Xóa nội dung cũ

        //     let skuCounts = {}; 
        //     let skuAvailableSet = new Set();

        //     // Lấy danh sách SKU từ `skuTable`
        //     Array.from(skuTable.querySelectorAll("tr")).forEach(row => {
        //         let skuID = row.cells[1].textContent.trim();
        //         skuCounts[skuID] = (skuCounts[skuID] || 0) + 1;
        //         skuAvailableSet.add(skuID);
        //     });

        //     let orderSummary = {}; 
        //     let validOrders = new Set();
        //     let orderSkuMap = {}; 
            
        //     tbs_data.forEach(row => {
        //         let orderNo = row[1];  
        //         let skuID = row[2];    
        //         let status = row[5];  

        //         if (!selectedStatuses.includes("All") && !selectedStatuses.includes(status)) {
        //             return;
        //         }

        //         if (!orderSkuMap[orderNo]) {
        //             orderSkuMap[orderNo] = new Set();
        //         }
        //         orderSkuMap[orderNo].add(skuID);
        //     });

        //     Object.entries(orderSkuMap).forEach(([orderNo, skuSet]) => {
        //         let allSkuExist = [...skuSet].every(sku => skuAvailableSet.has(sku));
        //         if (allSkuExist) {
        //             validOrders.add(orderNo);
        //         }
        //     });

        //     tbs_data.forEach(row => {
        //         let orderNo = row[1];  
        //         let skuID = row[2];    
        //         let requiredQty = parseInt(row[3]) || 0; 
        //         let status = row[5];   

        //         if (validOrders.has(orderNo)) {
        //             if (!orderSummary[orderNo]) {
        //                 orderSummary[orderNo] = { skus: [], allMatched: true, rowCount: 0 };
        //             }

        //             let currentQty = skuCounts[skuID] || 0; 

        //             if (currentQty < requiredQty) {
        //                 orderSummary[orderNo].allMatched = false;
        //             }

        //             orderSummary[orderNo].skus.push({
        //                 skuID: skuID,
        //                 requiredQty: requiredQty,
        //                 currentQty: currentQty,
        //                 status: status
        //             });

        //             orderSummary[orderNo].rowCount += 1; 
        //         }
        //     });

        //     console.log(orderSummary)

        //     Object.entries(orderSummary).forEach(([orderNo, details]) => {
        //         let orderMatched = details.allMatched; 
        //         let firstRow = true;
        //         let orderGroupClass = `order-group-${orderNo}`; 

        //         details.skus.forEach((skuInfo, index) => {
        //             let newRow = orderTable.insertRow();
        //             newRow.classList.add(orderGroupClass); // Gán class theo orderNo

        //             let skuCell = newRow.insertCell(0);
        //             skuCell.textContent = skuInfo.skuID;

        //             let qtyCell = newRow.insertCell(1);
        //             qtyCell.textContent = skuInfo.requiredQty;

        //             let currentQtyCell = newRow.insertCell(2);
        //             currentQtyCell.textContent = skuInfo.currentQty;

        //             if (skuInfo.currentQty >= skuInfo.requiredQty) {
        //                 skuCell.style.backgroundColor = "lightgreen";
        //             }

        //             if (index === 0) {
        //                 let orderCell = newRow.insertCell(3);
        //                 let orderButton = document.createElement("button");
        //                 orderButton.textContent = orderNo;
        //                 orderButton.classList.add("order-button");
        //                 orderButton.onclick = () => getBasket(orderNo);

        //                 orderCell.appendChild(orderButton);
        //                 orderCell.rowSpan = details.rowCount;

        //                 if (orderMatched) {
        //                     orderCell.style.backgroundColor = "lightgreen";
        //                 }
        //             }
        //         });
        //     });
        // }


        // function updateOrderTable(selectedStatuses = ["All"]) {

        //     let skuTable = document.getElementById("skuTable").querySelector("tbody");
        //     let orderTable = document.getElementById("orderTable").querySelector("tbody");

        //     orderTable.innerHTML = ""; // Xóa nội dung cũ

        //     let skuCounts = {}; // Lưu số lượng SKU trong skuTable

        //     // Lấy danh sách SKU ID từ skuTable
        //     Array.from(skuTable.querySelectorAll("tr")).forEach(row => {
        //         let skuID = row.cells[1].textContent; // SKU ID từ cột 2
        //         skuCounts[skuID] = (skuCounts[skuID] || 0) + 1; // Đếm số lần xuất hiện
        //     });

        //     let orderSummary = {}; // Lưu trữ thông tin order

        //     // **Bước 1: Tìm tất cả đơn hàng có SKU trong `skuTable` và lọc theo trạng thái**
        //     let matchedOrders = new Set();
        //     tbs_data.forEach(row => {
        //         let orderNo = row[1];  // Cột 2: Order No
        //         let skuID = row[2];    // Cột 3: SKU ID
        //         let status = row[5];   // Cột 6: Status (Trạng thái)

        //         // Nếu trạng thái không nằm trong danh sách đã chọn, bỏ qua
        //         if (!selectedStatuses.includes("All") && !selectedStatuses.includes(status)) {
        //             return;
        //         }

        //         if (skuCounts[skuID]) {
        //             matchedOrders.add(orderNo); // Lưu lại order có SKU
        //         }
        //     });

        //     // **Bước 2: Lấy toàn bộ SKU của các đơn hàng tìm được**
        //     tbs_data.forEach(row => {
        //         let orderNo = row[1];  // Cột 2: Order No
        //         let skuID = row[2];    // Cột 3: SKU ID
        //         let requiredQty = parseInt(row[3]) || 0; // Cột 4: Số lượng SKU cần
        //         let status = row[5];   // Cột 6: Status (Trạng thái)

        //         // Nếu order này có trong danh sách đã tìm được
        //         if (matchedOrders.has(orderNo)) {
        //             if (!orderSummary[orderNo]) {
        //                 orderSummary[orderNo] = { skus: [], allMatched: true, rowCount: 0 };
        //             }
        //             let currentQty = skuCounts[skuID] || 0; // Số lượng hiện có

        //             // Kiểm tra nếu số lượng không đủ, đánh dấu order chưa đủ
        //             if (currentQty < requiredQty) {
        //                 orderSummary[orderNo].allMatched = false;
        //             }

        //             orderSummary[orderNo].skus.push({
        //                 skuID: skuID,
        //                 requiredQty: requiredQty,
        //                 currentQty: currentQty,
        //                 status: status
        //             });

        //             orderSummary[orderNo].rowCount += 1; // Đếm số hàng cho `rowSpan`
        //         }
        //     });

        //     // **Bước 3: Hiển thị danh sách đơn hàng theo format yêu cầu**
        //     Object.entries(orderSummary).forEach(([orderNo, details]) => {
        //         let orderMatched = details.allMatched; // Kiểm tra nếu toàn bộ SKU của order đủ
        //         let firstRow = true;

        //         details.skus.forEach((skuInfo, index) => {
        //             let newRow = orderTable.insertRow(); // Luôn tạo dòng mới

        //             // Tạo ô cho SKU ID
        //             let skuCell = newRow.insertCell(0);
        //             skuCell.textContent = skuInfo.skuID;

        //             // Tạo ô cho SL của đơn hàng
        //             let qtyCell = newRow.insertCell(1);
        //             qtyCell.textContent = skuInfo.requiredQty;

        //             // Tạo ô cho SL TBS hiện có
        //             let currentQtyCell = newRow.insertCell(2);
        //             currentQtyCell.textContent = skuInfo.currentQty;

        //             // Nếu số lượng đủ, highlight SKU
        //             if (skuInfo.currentQty >= skuInfo.requiredQty) {
        //                 skuCell.style.backgroundColor = "lightgreen";
        //             }

        //             // Chỉ thêm ô `Mã đơn hàng` vào dòng đầu tiên
        //             if (index === 0) {
        //                 let orderCell = newRow.insertCell(3);
        //                 let orderButton = document.createElement("button");
        //                 orderButton.textContent = orderNo;
        //                 orderButton.classList.add("order-button");
        //                 orderButton.onclick = () => console.log(`Order clicked: ${orderNo}`);

        //                 orderCell.appendChild(orderButton);
        //                 orderCell.rowSpan = details.rowCount; // Gộp ô theo số SKU

        //                 if (orderMatched) {
        //                     orderCell.style.backgroundColor = "lightgreen"; // Highlight nếu đủ SKU
        //                 }
        //             }
        //         });
        //     });
        // }


        function toggleSidebar() {
            document.getElementById("sidebar").classList.toggle("collapsed");
            document.getElementById("content").classList.toggle("collapsed");
        }

        let refreshInterval = null; // Lưu interval ID

        // Hàm thiết lập interval khi vào frame `searchOrder`
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval); // Đảm bảo không bị chạy nhiều lần
            }
            refreshInterval = setInterval(() => {
                console.log("🔄 Tự động làm mới dữ liệu đơn hàng...");
                load_data().then(() => {
                    updateOrderTable(); // Cập nhật lại bảng sau khi load
                });
            }, 30 * 60 * 1000); // 30 phút 30 * 60 * 1000
        }

        // Hàm hủy interval khi rời frame `searchOrder`
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        

        function showFrame(frameId) {
            let frames = document.querySelectorAll('.frame');
            frames.forEach(frame => frame.classList.remove('active'));

            document.getElementById("loading").style.display = "block"; // Hiển thị loading

            document.getElementById(frameId).classList.add('active');
            console.log(`Frame ${frameId} is active.`);

            let loadDataPromise = Promise.resolve();

            if (frameId === "searchOrder") {
                loadDataPromise = load_data();
                startAutoRefresh(); // Bắt đầu tự động làm mới mỗi 30 phút
            } else {
                stopAutoRefresh(); // Ngừng làm mới nếu không ở frame `searchOrder`
            }

            if (frameId === "vnsSkuMap") {
                loadDataPromise = load_sku_map();
                // startAutoRefresh(); // Bắt đầu tự động làm mới mỗi 30 phút
            }

            loadDataPromise.then(() => {
                document.getElementById("loading").style.display = "none";
            });
        }



        function addToTable(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                let input = document.getElementById("searchInput");
                let skuValue = input.value.trim();

                if (skuValue === "") return;

                // Tìm kiếm trong tbs_data (cột 2, 6, 7, 8)
                let matchedRow = original_data.find(row => 
                    row[2].includes(skuValue) || 
                    row[6].includes(skuValue) || 
                    row[7].includes(skuValue) || 
                    row[8].includes(skuValue)
                );

                if (!matchedRow) {
                    alert("Không tìm thấy SKU trong dữ liệu!");
                    input.value = "";
                    return;
                }

                let skuID = matchedRow[2]; // Lấy giá trị cột 2 (SKU ID)

                let table = document.getElementById("skuTable").querySelector("tbody");

                let newRow = table.insertRow();
                let skuCell = newRow.insertCell(0);
                let skuIDCell = newRow.insertCell(1);
                let actionCell = newRow.insertCell(2);

                skuCell.textContent = skuValue;
                skuIDCell.textContent = skuID;

                let deleteButton = document.createElement("button");
                deleteButton.textContent = "Xóa";
                deleteButton.className = "delete-btn";
                deleteButton.onclick = function () {
                    table.removeChild(newRow);
                    updateOrderTable(); // Cập nhật bảng đơn hàng sau khi xóa SKU
                };

                actionCell.appendChild(deleteButton);

                input.value = "";
                updateOrderTable(); 
            }
        }


        // Lắng nghe sự kiện thay đổi kho
        document.getElementById("selectWarehouse").addEventListener("change", function () {
            let selectedWarehouse = this.value;
            console.log(`Kho được chọn: ${selectedWarehouse}`);
            tbs_data = original_data.filter(row => row[0] === selectedWarehouse);

            // Gọi hàm cập nhật bảng dựa trên kho được chọn
            updateOrderTable()
        });

        // Hàm lọc dữ liệu theo kho
        function filterByWarehouse(warehouse) {
            let orderTable = document.getElementById("orderTable").querySelector("tbody");

            orderTable.innerHTML = ""; // Xóa bảng trước khi cập nhật

            let skuCounts = {}; // Lưu số lượng SKU trong bảng skuTable
            let skuTable = document.getElementById("skuTable").querySelector("tbody");

            // Lấy danh sách SKU từ bảng skuTable
            Array.from(skuTable.querySelectorAll("tr")).forEach(row => {
                let skuID = row.cells[1].textContent;
                skuCounts[skuID] = (skuCounts[skuID] || 0) + 1;
            });

            let orderSummary = {}; // Lưu dữ liệu đơn hàng theo kho

            // Lọc dữ liệu dựa trên kho được chọn
            original_data.forEach(row => {
                let warehouseID = row[0]; // Cột 1: Mã kho
                let orderNo = row[1];  // Cột 2: Order No
                let skuID = row[2];    // Cột 3: SKU ID
                let requiredQty = parseInt(row[3]) || 0; // Cột 4: Số lượng SKU

                // Chỉ lấy dữ liệu của kho được chọn
                if (warehouseID === warehouse) {
                    if (!orderSummary[orderNo]) {
                        orderSummary[orderNo] = { skus: [], allMatched: true, rowCount: 0 };
                    }

                    let currentQty = skuCounts[skuID] || 0; // Số lượng SKU hiện có

                    // Kiểm tra số lượng đủ hay không
                    if (currentQty < requiredQty) {
                        orderSummary[orderNo].allMatched = false;
                    }

                    orderSummary[orderNo].skus.push({
                        skuID: skuID,
                        requiredQty: requiredQty,
                        currentQty: currentQty
                    });

                    orderSummary[orderNo].rowCount += 1;
                }
            });

            // Cập nhật bảng orderTable với dữ liệu lọc theo kho
            Object.entries(orderSummary).forEach(([orderNo, details]) => {
                let firstRow = true;
                let orderMatched = details.allMatched;

                let orderGroup = document.createElement("tbody");
                orderGroup.classList.add("order-group");

                details.skus.forEach((skuInfo, index) => {
                    let newRow = orderGroup.insertRow();

                    let skuCell = newRow.insertCell(0);
                    skuCell.textContent = skuInfo.skuID;

                    let qtyCell = newRow.insertCell(1);
                    qtyCell.textContent = skuInfo.requiredQty;

                    let currentQtyCell = newRow.insertCell(2);
                    currentQtyCell.textContent = skuInfo.currentQty;

                    if (skuInfo.currentQty >= skuInfo.requiredQty) {
                        skuCell.style.backgroundColor = "lightgreen";
                    }

                    if (index === 0) {
                        let orderCell = newRow.insertCell(3);
                        let orderButton = document.createElement("button");
                        orderButton.textContent = orderNo;
                        orderButton.classList.add("order-button");
                        orderButton.onclick = () => getBasket(orderNo);

                        orderCell.appendChild(orderButton);
                        orderCell.rowSpan = details.rowCount;

                        if (orderMatched) {
                            orderCell.style.backgroundColor = "lightgreen";
                        }
                    }
                });

                orderTable.appendChild(orderGroup);
            });
        }

        async function downloadAll(order, bsk) {
            let pdfDoc = await PDFLib.PDFDocument.create();
            let pdfWidth = 288;
            let pdfHeight = 144;
            let canvas = document.createElement("canvas");
            canvas.width = 800;
            canvas.height = 400;
            let counter = 1; // Bắt đầu từ 1

            // 🖨️ **Tạo barcode cho Location**
            let barcodeImage = await generateBarcode(bsk);
            let barcodeImage2 = await generateBarcode(order);

            // 🎨 **Thiết Kế Nhãn Trên Canvas**
            let ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);


            // 🏷️ **Thông tin SKU**
            ctx.fillStyle = "black";
            ctx.font = "bold 30px Arial";
            ctx.fillText("Troubleshoots", 30, 100);

            // 3️⃣ **Vẽ Barcode**
            let barcodeImg2 = new Image();
            await new Promise(resolve => {
                barcodeImg2.onload = resolve;
                barcodeImg2.src = barcodeImage2;
            });
            ctx.drawImage(barcodeImg2, 30, 100, 400, 120);

            // 3️⃣ **Vẽ Barcode**
            let barcodeImg = new Image();
            await new Promise(resolve => {
                barcodeImg.onload = resolve;
                barcodeImg.src = barcodeImage;
            });
            ctx.drawImage(barcodeImg, 30, 260, 400, 120);

            // 4️⃣ **Chuyển Canvas Thành Ảnh Và Nhúng Vào PDF**
            let imgBytes = canvas.toDataURL("image/png").split(",")[1];
            let imgBuffer = Uint8Array.from(atob(imgBytes), c => c.charCodeAt(0));
            let img = await pdfDoc.embedPng(imgBuffer);

            let page = pdfDoc.addPage([pdfWidth, pdfHeight]);
            page.drawImage(img, { x: 0, y: 0, width: pdfWidth, height: pdfHeight });

            let pdfBytes = await pdfDoc.save();
            let blob = new Blob([pdfBytes], { type: "application/pdf" });
            let blobUrl = URL.createObjectURL(blob);

            let link = document.createElement("a");
            link.href = blobUrl;
            link.download = "Labels.pdf";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        }

        function generateBarcode(text, fontSize = 30) {
            let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");

            JsBarcode(svg, text, {
                format: "CODE128",
                displayValue: true, // Hiển thị giá trị dưới barcode
                fontSize: fontSize, // Kích thước chữ của value
                // fontOptions: "bold", // Làm đậm chữ
                width: 2, // Độ rộng vạch barcode
                // height: barcodeHeight, // Chiều cao của barcode
                margin: 10 // Khoảng cách lề
            });

            let xml = new XMLSerializer().serializeToString(svg);
            let svg64 = btoa(xml);
            return "data:image/svg+xml;base64," + svg64;
        }

        function getBasket(order) {
            const foundBsk = original_data.find(row => row[1] === order);
            if (!foundBsk) {
                downloadAll(order, "---")
            }
            var bsk = foundBsk[4]
            if (bsk === "") {
                bsk = "-"
            }
            console.log(bsk)
            downloadAll(order, bsk)
        }

    // SKU MAP
    let sku_map_data = [];
    async function load_sku_map() {
        return fetch('https://script.google.com/macros/s/AKfycbwqrPLe5Po68CUpx8M-ct31eR5Tnuc3YOkSOBu71qiOsUenNLXs3skZBJK3bmh-ieF2qg/exec')
            .then(res => res.json())
            .then(data => {
                sku_map_data = data.content;
                console.log("Load dữ liệu SKU MAP thành công:", sku_map_data);
            });
    }

    document.addEventListener("DOMContentLoaded", function () {
        let searchSku = document.getElementById("searchSku");
        let isActive = false;

        // Khi frame vnsSkuMap active, lắng nghe sự kiện bàn phím
        function activateFrame() {
            isActive = true;
            // document.addEventListener("keydown", handleKeyPress);
        }

        // Khi chuyển sang frame khác, tắt lắng nghe
        function deactivateFrame() {
            isActive = false;
            // document.removeEventListener("keydown", handleKeyPress);
            searchSku.value = ""; // Xóa nội dung input khi rời frame
        }

        // Lắng nghe sự kiện "input" thay vì "keydown"
        searchSku.addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                handleEnterPress(searchSku.value.trim()); 
                searchSku.value = ""; 
            }
        });

        // Hàm thực thi khi nhấn Enter
        function handleEnterPress(value) {
            if (value) {
                console.log("Người dùng nhập:", value);
                let matchedRow = sku_map_data.find(row => 
                    String(row[0]).includes(value) || 
                    String(row[5]).includes(value) || 
                    String(row[6]).includes(value) || 
                    String(row[7]).includes(value)
                );

                if (!matchedRow) {
                    let errorMessage = document.getElementById("errorMessage");
                    errorMessage.textContent = `❌ Không tìm thấy SKU: ${value}`;
                    errorMessage.style.display = "block"; // Hiển thị thông báo lỗi

                    document.getElementById("zoneId").textContent = "";
                    document.getElementById("skuId").textContent = "";
                    document.getElementById("shopName").textContent = "";
                    document.getElementById("skuName").textContent = "";
                    document.getElementById("zoneInfo").style.backgroundColor = "";
                    return;
                }

                document.getElementById("errorMessage").style.display = "none";
                let skuID = matchedRow[0]; 
                let zoneID = matchedRow[3]; // Giá trị có thể là A, C, D, SP
                let shopName = matchedRow[2];
                let skuName = matchedRow[4];

                document.getElementById("zoneId").textContent = zoneID;
                document.getElementById("skuId").textContent = skuID;
                document.getElementById("shopName").textContent = shopName;
                document.getElementById("skuName").textContent = skuName;
                document.getElementById("zoneInfo").style.backgroundColor = "lightgreen";

                // 🔊 Phát âm thanh tương ứng
                let audioFile = `materials/zone/${zoneID}.mp3`;
                let audio = new Audio(audioFile);
                audio.play();
            }
        }


        // ✅ Cập nhật lại sự kiện click của menu sau khi DOM load xong
        document.querySelectorAll("a[href^='#']").forEach(link => {
            link.addEventListener("click", function (event) {
                event.preventDefault();
                let frameId = this.getAttribute("onclick").match(/showFrame\('(.+?)'\)/)[1];
                showFrame2(frameId);
            });
        });
        // ✅ Giữ nguyên hàm `showFrame`
        function showFrame2(frameId) {
            let frames = document.querySelectorAll(".frame");
            frames.forEach(frame => frame.classList.remove("active"));
            document.getElementById(frameId).classList.add("active");

            if (frameId === "vnsSkuMap") {
                activateFrame();
            } else {
                deactivateFrame();
            }
        }

    });

    </script>
</body>
</html>
